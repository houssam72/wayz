{"ast":null,"code":"import * as THREE from 'three';\nimport * as React from 'react';\nimport create from 'zustand';\nimport shallow from 'zustand/shallow';\nimport Reconciler from 'react-reconciler';\nimport { unstable_now, unstable_runWithPriority, unstable_IdlePriority } from 'scheduler';\nimport { useAsset } from 'use-asset';\nimport useMeasure from 'react-use-measure';\nvar threeTypes = /*#__PURE__*/Object.freeze({\n  __proto__: null\n});\nconst is = {\n  obj: a => a === Object(a) && !is.arr(a) && typeof a !== 'function',\n  fun: a => typeof a === 'function',\n  str: a => typeof a === 'string',\n  num: a => typeof a === 'number',\n  und: a => a === void 0,\n  arr: a => Array.isArray(a),\n\n  equ(a, b) {\n    // Wrong type or one of the two undefined, doesn't match\n    if (typeof a !== typeof b || !!a !== !!b) return false; // Atomic, just compare a against b\n\n    if (is.str(a) || is.num(a) || is.obj(a)) return a === b; // Array, shallow compare first to see if it's a match\n\n    if (is.arr(a) && a == b) return true; // Last resort, go through keys\n\n    let i;\n\n    for (i in a) if (!(i in b)) return false;\n\n    for (i in b) if (a[i] !== b[i]) return false;\n\n    return is.und(i) ? a === b : true;\n  }\n\n};\n\nfunction makeId(event) {\n  return (event.eventObject || event.object).uuid + '/' + event.index;\n}\n\nfunction removeInteractivity(store, object) {\n  const {\n    internal\n  } = store.getState(); // Removes every trace of an object from the data store\n\n  internal.interaction = internal.interaction.filter(o => o !== object);\n  internal.initialHits = internal.initialHits.filter(o => o !== object);\n  internal.hovered.forEach((value, key) => {\n    if (value.eventObject === object || value.object === object) {\n      internal.hovered.delete(key);\n    }\n  });\n}\n\nfunction createEvents(store) {\n  const temp = new THREE.Vector3();\n  /** Sets up defaultRaycaster */\n\n  function prepareRay(event) {\n    var _raycaster$computeOff;\n\n    const state = store.getState();\n    const {\n      raycaster,\n      mouse,\n      camera,\n      size\n    } = state; // https://github.com/pmndrs/react-three-fiber/pull/782\n    // Events trigger outside of canvas when moved\n\n    const {\n      offsetX,\n      offsetY\n    } = (_raycaster$computeOff = raycaster.computeOffsets == null ? void 0 : raycaster.computeOffsets(event, state)) != null ? _raycaster$computeOff : event;\n    const {\n      width,\n      height\n    } = size;\n    mouse.set(offsetX / width * 2 - 1, -(offsetY / height) * 2 + 1);\n    raycaster.setFromCamera(mouse, camera);\n  }\n  /** Calculates delta */\n\n\n  function calculateDistance(event) {\n    const {\n      internal\n    } = store.getState();\n    const dx = event.offsetX - internal.initialClick[0];\n    const dy = event.offsetY - internal.initialClick[1];\n    return Math.round(Math.sqrt(dx * dx + dy * dy));\n  }\n  /** Returns true if an instance has a valid pointer-event registered, this excludes scroll, clicks etc */\n\n\n  function filterPointerEvents(objects) {\n    return objects.filter(obj => ['Move', 'Over', 'Enter', 'Out', 'Leave'].some(name => {\n      var _r3f$handlers;\n\n      return (_r3f$handlers = obj.__r3f.handlers) == null ? void 0 : _r3f$handlers['onPointer' + name];\n    }));\n  }\n\n  function intersect(filter) {\n    const state = store.getState();\n    const {\n      raycaster,\n      internal\n    } = state; // Skip event handling when noEvents is set\n\n    if (!raycaster.enabled) return [];\n    const seen = new Set();\n    const intersections = []; // Allow callers to eliminate event objects\n\n    const eventsObjects = filter ? filter(internal.interaction) : internal.interaction; // Intersect known handler objects and filter against duplicates\n\n    let intersects = raycaster.intersectObjects(eventsObjects, true).filter(item => {\n      const id = makeId(item);\n      if (seen.has(id)) return false;\n      seen.add(id);\n      return true;\n    }); // https://github.com/mrdoob/three.js/issues/16031\n    // Allow custom userland intersect sort order\n\n    if (raycaster.filter) intersects = raycaster.filter(intersects, state);\n\n    for (const intersect of intersects) {\n      let eventObject = intersect.object; // Bubble event up\n\n      while (eventObject) {\n        var _r3f;\n\n        const handlers = (_r3f = eventObject.__r3f) == null ? void 0 : _r3f.handlers;\n        if (handlers) intersections.push({ ...intersect,\n          eventObject\n        });\n        eventObject = eventObject.parent;\n      }\n    }\n\n    return intersections;\n  }\n  /**  Creates filtered intersects and returns an array of positive hits */\n\n\n  function patchIntersects(intersections, event) {\n    const {\n      internal\n    } = store.getState(); // If the interaction is captured take that into account, the captured event has to be part of the intersects\n\n    if (internal.captured && event.type !== 'click' && event.type !== 'wheel') {\n      internal.captured.forEach(captured => {\n        if (!intersections.find(hit => hit.eventObject === captured.eventObject)) intersections.push(captured);\n      });\n    }\n\n    return intersections;\n  }\n  /**  Handles intersections by forwarding them to handlers */\n\n\n  function handleIntersects(intersections, event, callback) {\n    const {\n      raycaster,\n      mouse,\n      camera,\n      internal\n    } = store.getState(); // If anything has been found, forward it to the event listeners\n\n    if (intersections.length) {\n      const unprojectedPoint = temp.set(mouse.x, mouse.y, 0).unproject(camera);\n      const delta = event.type === 'click' ? calculateDistance(event) : 0;\n\n      const releasePointerCapture = id => event.target.releasePointerCapture(id);\n\n      const localState = {\n        stopped: false,\n        captured: false\n      };\n\n      for (const hit of intersections) {\n        const setPointerCapture = id => {\n          // If the hit is going to be captured flag that we're in captured state\n          if (!localState.captured) {\n            localState.captured = true; // The captured hit array is reset to collect hits\n\n            internal.captured = [];\n          } // Push hits to the array\n\n\n          if (internal.captured) internal.captured.push(hit) // Call the original event now\n          ;\n          event.target.setPointerCapture(id);\n        }; // Add native event props\n\n\n        let extractEventProps = {};\n\n        for (let prop in Object.getPrototypeOf(event)) {\n          extractEventProps[prop] = event[prop];\n        }\n\n        let raycastEvent = { ...hit,\n          ...extractEventProps,\n          intersections,\n          stopped: localState.stopped,\n          delta,\n          unprojectedPoint,\n          ray: raycaster.ray,\n          camera: camera,\n          // Hijack stopPropagation, which just sets a flag\n          stopPropagation: () => {\n            // https://github.com/pmndrs/react-three-fiber/issues/596\n            // Events are not allowed to stop propagation if the pointer has been captured\n            const cap = internal.captured;\n\n            if (!cap || cap.find(h => h.eventObject.id === hit.eventObject.id)) {\n              raycastEvent.stopped = localState.stopped = true; // Propagation is stopped, remove all other hover records\n              // An event handler is only allowed to flush other handlers if it is hovered itself\n\n              if (internal.hovered.size && Array.from(internal.hovered.values()).find(i => i.eventObject === hit.eventObject)) {\n                // Objects cannot flush out higher up objects that have already caught the event\n                const higher = intersections.slice(0, intersections.indexOf(hit));\n                cancelPointer([...higher, hit]);\n              }\n            }\n          },\n          target: { ...event.target,\n            setPointerCapture,\n            releasePointerCapture\n          },\n          currentTarget: { ...event.currentTarget,\n            setPointerCapture,\n            releasePointerCapture\n          },\n          sourceEvent: event\n        }; // Call subscribers\n\n        callback(raycastEvent); // Event bubbling may be interrupted by stopPropagation\n\n        if (localState.stopped === true) break;\n      }\n    }\n\n    return intersections;\n  }\n\n  function cancelPointer(hits) {\n    const {\n      internal\n    } = store.getState();\n    Array.from(internal.hovered.values()).forEach(hoveredObj => {\n      // When no objects were hit or the the hovered object wasn't found underneath the cursor\n      // we call onPointerOut and delete the object from the hovered-elements map\n      if (!hits.length || !hits.find(hit => hit.object === hoveredObj.object && hit.index === hoveredObj.index)) {\n        const eventObject = hoveredObj.eventObject;\n        const handlers = eventObject.__r3f.handlers;\n        internal.hovered.delete(makeId(hoveredObj));\n\n        if (handlers) {\n          // Clear out intersects, they are outdated by now\n          const data = { ...hoveredObj,\n            intersections: hits || []\n          };\n          handlers.onPointerOut == null ? void 0 : handlers.onPointerOut(data);\n          handlers.onPointerLeave == null ? void 0 : handlers.onPointerLeave(data);\n        }\n      }\n    });\n  }\n\n  const handlePointer = name => {\n    // Deal with cancelation\n    switch (name) {\n      case 'onPointerLeave':\n      case 'onPointerCancel':\n        return () => cancelPointer([]);\n\n      case 'onLostPointerCapture':\n        return () => (store.getState().internal.captured = undefined, cancelPointer([]));\n    } // Any other pointer goes here ...\n\n\n    return event => {\n      const {\n        onPointerMissed,\n        internal\n      } = store.getState();\n      prepareRay(event); // Get fresh intersects\n\n      const isPointerMove = name === 'onPointerMove';\n      const filter = isPointerMove ? filterPointerEvents : undefined;\n      const hits = patchIntersects(intersect(filter), event); // Take care of unhover\n\n      if (isPointerMove) cancelPointer(hits);\n      handleIntersects(hits, event, data => {\n        const eventObject = data.eventObject;\n        const handlers = eventObject.__r3f.handlers; // Check presence of handlers\n\n        if (!handlers) return;\n\n        if (isPointerMove) {\n          // Move event ...\n          if (handlers.onPointerOver || handlers.onPointerEnter || handlers.onPointerOut || handlers.onPointerLeave) {\n            // When enter or out is present take care of hover-state\n            const id = makeId(data);\n            const hoveredItem = internal.hovered.get(id);\n\n            if (!hoveredItem) {\n              // If the object wasn't previously hovered, book it and call its handler\n              internal.hovered.set(id, data);\n              handlers.onPointerOver == null ? void 0 : handlers.onPointerOver(data);\n              handlers.onPointerEnter == null ? void 0 : handlers.onPointerEnter(data);\n            } else if (hoveredItem.stopped) {\n              // If the object was previously hovered and stopped, we shouldn't allow other items to proceed\n              data.stopPropagation();\n            }\n          } // Call mouse move\n\n\n          handlers.onPointerMove == null ? void 0 : handlers.onPointerMove(data);\n        } else {\n          // All other events ...\n          const handler = handlers == null ? void 0 : handlers[name];\n\n          if (handler) {\n            // Forward all events back to their respective handlers with the exception of click events,\n            // which must use the initial target\n            if (name !== 'onClick' && name !== 'onContextMenu' && name !== 'onDoubleClick' || internal.initialHits.includes(eventObject)) {\n              handler(data);\n              pointerMissed(event, internal.interaction.filter(object => object !== eventObject));\n            }\n          }\n        }\n      }); // Save initial coordinates on pointer-down\n\n      if (name === 'onPointerDown') {\n        internal.initialClick = [event.offsetX, event.offsetY];\n        internal.initialHits = hits.map(hit => hit.eventObject);\n      } // If a click yields no results, pass it back to the user as a miss\n\n\n      if ((name === 'onClick' || name === 'onContextMenu' || name === 'onDoubleClick') && !hits.length) {\n        if (calculateDistance(event) <= 2) {\n          pointerMissed(event, internal.interaction);\n          if (onPointerMissed) onPointerMissed();\n        }\n      }\n    };\n  };\n\n  function pointerMissed(event, objects) {\n    objects.forEach(object => {\n      var _r3f$handlers2;\n\n      return (_r3f$handlers2 = object.__r3f.handlers) == null ? void 0 : _r3f$handlers2.onPointerMissed == null ? void 0 : _r3f$handlers2.onPointerMissed(event);\n    });\n  }\n\n  return {\n    handlePointer\n  };\n} // Type guard to tell a store from a portal\n\n\nconst isStore = def => def && !!def.getState;\n\nconst getContainer = (container, child) => {\n  var _container$__r3f$root, _container$__r3f;\n\n  return {\n    // If the container is not a root-store then it must be a THREE.Object3D into which part of the\n    // scene is portalled into. Now there can be two variants of this, either that object is part of\n    // the regular jsx tree, in which case it already has __r3f with a valid root attached, or it lies\n    // outside react, in which case we must take the root of the child that is about to be attached to it.\n    root: isStore(container) ? container : (_container$__r3f$root = (_container$__r3f = container.__r3f) == null ? void 0 : _container$__r3f.root) != null ? _container$__r3f$root : child.__r3f.root,\n    // The container is the eventual target into which objects are mounted, it has to be a THREE.Object3D\n    container: isStore(container) ? container.getState().scene : container\n  };\n};\n\nconst DEFAULT = '__default';\nconst EMPTY = {};\nconst FILTER = ['children', 'key', 'ref'];\nlet catalogue = {};\n\nlet extend = objects => void (catalogue = { ...catalogue,\n  ...objects\n}); // Each object in the scene carries a small LocalState descriptor\n\n\nfunction prepare(object, state) {\n  const instance = object;\n\n  if (!instance.__r3f) {\n    instance.__r3f = {\n      root: null,\n      memoizedProps: {},\n      objects: [],\n      ...state\n    };\n  }\n\n  return object;\n}\n\nfunction createRenderer(roots) {\n  function applyProps(instance, newProps, oldProps = {}, accumulative = false) {\n    var _instance$__r3f, _root$getState, _instance$__r3f2; // Filter equals, events and reserved props\n\n\n    const localState = (_instance$__r3f = instance == null ? void 0 : instance.__r3f) != null ? _instance$__r3f : {};\n    const root = localState.root;\n    const rootState = (_root$getState = root == null ? void 0 : root.getState == null ? void 0 : root.getState()) != null ? _root$getState : {};\n    const sameProps = [];\n    const handlers = [];\n    const newMemoizedProps = {};\n    let i = 0;\n    Object.entries(newProps).forEach(([key, entry]) => {\n      // we don't want children, ref or key in the memoized props\n      if (FILTER.indexOf(key) === -1) {\n        newMemoizedProps[key] = entry;\n      }\n    });\n\n    if (localState.memoizedProps && localState.memoizedProps.args) {\n      newMemoizedProps.args = localState.memoizedProps.args;\n    }\n\n    if (localState.memoizedProps && localState.memoizedProps.attach) {\n      newMemoizedProps.attach = localState.memoizedProps.attach;\n    }\n\n    if (instance.__r3f) {\n      instance.__r3f.memoizedProps = newMemoizedProps;\n    }\n\n    let objectKeys = Object.keys(newProps);\n\n    for (i = 0; i < objectKeys.length; i++) {\n      if (is.equ(newProps[objectKeys[i]], oldProps[objectKeys[i]])) {\n        sameProps.push(objectKeys[i]);\n      } // Event-handlers ...\n      //   are functions, that\n      //   start with \"on\", and\n      //   contain the name \"Pointer\", \"Click\", \"DoubleClick\", \"ContextMenu\", or \"Wheel\"\n\n\n      if (is.fun(newProps[objectKeys[i]]) && /^on(Pointer|Click|DoubleClick|ContextMenu|Wheel)/.test(objectKeys[i])) {\n        handlers.push(objectKeys[i]);\n      }\n    } // Catch props that existed, but now exist no more ...\n\n\n    const leftOvers = [];\n\n    if (accumulative) {\n      objectKeys = Object.keys(oldProps);\n\n      for (i = 0; i < objectKeys.length; i++) {\n        if (!newProps.hasOwnProperty(objectKeys[i])) {\n          leftOvers.push(objectKeys[i]);\n        }\n      }\n    }\n\n    const toFilter = [...sameProps, ...FILTER]; // Instances use \"object\" as a reserved identifier\n\n    if ((_instance$__r3f2 = instance.__r3f) != null && _instance$__r3f2.instance) toFilter.push('object');\n    const filteredProps = { ...newProps\n    }; // Removes sameProps and reserved props from newProps\n\n    objectKeys = Object.keys(filteredProps);\n\n    for (i = 0; i < objectKeys.length; i++) {\n      if (toFilter.indexOf(objectKeys[i]) > -1) {\n        delete filteredProps[objectKeys[i]];\n      }\n    } // Collect all new props\n\n\n    const filteredPropsEntries = Object.entries(filteredProps); // Prepend left-overs so they can be reset or removed\n    // Left-overs must come first!\n\n    for (i = 0; i < leftOvers.length; i++) {\n      if (leftOvers[i] !== 'children') {\n        filteredPropsEntries.unshift([leftOvers[i], DEFAULT + 'remove']);\n      }\n    }\n\n    if (filteredPropsEntries.length > 0) {\n      filteredPropsEntries.forEach(([key, value]) => {\n        if (!handlers.includes(key)) {\n          let currentInstance = instance;\n          let targetProp = currentInstance[key];\n\n          if (key.includes('-')) {\n            const entries = key.split('-');\n            targetProp = entries.reduce((acc, key) => acc[key], instance); // If the target is atomic, it forces us to switch the root\n\n            if (!(targetProp && targetProp.set)) {\n              const [name, ...reverseEntries] = entries.reverse();\n              currentInstance = reverseEntries.reverse().reduce((acc, key) => acc[key], instance);\n              key = name;\n            }\n          } // https://github.com/mrdoob/three.js/issues/21209\n          // HMR/fast-refresh relies on the ability to cancel out props, but threejs\n          // has no means to do this. Hence we curate a small collection of value-classes\n          // with their respective constructor/set arguments\n          // For removed props, try to set default values, if possible\n\n\n          if (value === DEFAULT + 'remove') {\n            if (targetProp && targetProp.constructor) {\n              // use the prop constructor to find the default it should be\n              value = new targetProp.constructor(newMemoizedProps.args);\n            } else if (currentInstance.constructor) {\n              // create a blank slate of the instance and copy the particular parameter.\n              // @ts-ignore\n              const defaultClassCall = new currentInstance.constructor(currentInstance.__r3f.memoizedProps.args);\n              value = defaultClassCall[targetProp]; // destory the instance\n\n              if (defaultClassCall.dispose) {\n                defaultClassCall.dispose();\n              }\n            } else {\n              // instance does not have constructor, just set it to 0\n              value = 0;\n            }\n          } // Special treatment for objects with support for set/copy, and layers\n\n\n          if (targetProp && targetProp.set && (targetProp.copy || targetProp instanceof THREE.Layers)) {\n            // If value is an array\n            if (Array.isArray(value)) {\n              if (targetProp.fromArray) {\n                targetProp.fromArray(value);\n              } else {\n                targetProp.set(...value);\n              }\n            } // Test again target.copy(class) next ...\n            else if (targetProp.copy && value && value.constructor && targetProp.constructor.name === value.constructor.name) {\n                targetProp.copy(value);\n              } // If nothing else fits, just set the single value, ignore undefined\n              // https://github.com/react-spring/react-three-fiber/issues/274\n              else if (value !== undefined) {\n                  const isColor = targetProp instanceof THREE.Color; // Allow setting array scalars\n\n                  if (!isColor && targetProp.setScalar) targetProp.setScalar(value); // Layers have no copy function, we must therefore copy the mask property\n                  else if (targetProp instanceof THREE.Layers && value instanceof THREE.Layers) targetProp.mask = value.mask; // Otherwise just set ...\n                    else targetProp.set(value); // Auto-convert sRGB colors, for now ...\n                  // https://github.com/react-spring/react-three-fiber/issues/344\n\n                  if (!rootState.linear && isColor) targetProp.convertSRGBToLinear();\n                } // Else, just overwrite the value\n\n          } else {\n            currentInstance[key] = value; // Auto-convert sRGB textures, for now ...\n            // https://github.com/react-spring/react-three-fiber/issues/344\n\n            if (!rootState.linear && currentInstance[key] instanceof THREE.Texture) currentInstance[key].encoding = THREE.sRGBEncoding;\n          }\n\n          invalidateInstance(instance);\n        }\n      }); // Preemptively delete the instance from the containers interaction\n\n      if (accumulative && root && instance.raycast && localState.handlers) {\n        localState.handlers = undefined;\n        const index = rootState.internal.interaction.indexOf(instance);\n        if (index > -1) rootState.internal.interaction.splice(index, 1);\n      } // Prep interaction handlers\n\n\n      if (handlers.length) {\n        if (accumulative && root && instance.raycast) {\n          rootState.internal.interaction.push(instance);\n        } // Add handlers to the instances handler-map\n\n\n        localState.handlers = handlers.reduce((acc, key) => ({ ...acc,\n          [key]: newProps[key]\n        }), {});\n      } // Call the update lifecycle when it is being updated, but only when it is part of the scene\n\n\n      if (instance.parent) updateInstance(instance);\n    }\n  }\n\n  function invalidateInstance(instance) {\n    var _instance$__r3f3, _instance$__r3f3$root;\n\n    const state = (_instance$__r3f3 = instance.__r3f) == null ? void 0 : (_instance$__r3f3$root = _instance$__r3f3.root) == null ? void 0 : _instance$__r3f3$root.getState == null ? void 0 : _instance$__r3f3$root.getState();\n    if (state && state.internal.frames === 0) state.invalidate();\n  }\n\n  function updateInstance(instance) {\n    instance.onUpdate == null ? void 0 : instance.onUpdate(instance);\n  }\n\n  function createInstance(type, {\n    args = [],\n    ...props\n  }, root, hostContext, internalInstanceHandle) {\n    let name = `${type[0].toUpperCase()}${type.slice(1)}`;\n    let instance; // https://github.com/facebook/react/issues/17147\n    // Portals do not give us a root, they are themselves treated as a root by the reconciler\n    // In order to figure out the actual root we have to climb through fiber internals :(\n\n    if (!isStore(root) && internalInstanceHandle) {\n      const fn = node => {\n        if (!node.return) return node.stateNode && node.stateNode.containerInfo;else return fn(node.return);\n      };\n\n      root = fn(internalInstanceHandle);\n    } // Assert that by now we have a valid root\n\n\n    if (!root || !isStore(root)) throw `No valid root for ${name}!`;\n\n    if (type === 'primitive') {\n      if (props.object === undefined) throw `Primitives without 'object' are invalid!`;\n      const object = props.object;\n      instance = prepare(object, {\n        root,\n        instance: true\n      });\n    } else {\n      const target = catalogue[name] || THREE[name];\n      if (!target) throw `${name} is not part of the THREE namespace! Did you forget to extend? See: https://github.com/pmndrs/react-three-fiber/blob/master/markdown/api.md#using-3rd-party-objects-declaratively`;\n      const isArgsArr = is.arr(args); // Instanciate new object, link it to the root\n\n      instance = prepare(isArgsArr ? new target(...args) : new target(args), {\n        root,\n        // append memoized props with args so it's not forgotten\n        memoizedProps: {\n          args: isArgsArr && args.length === 0 ? null : args\n        }\n      });\n    } // Auto-attach geometries and materials\n\n\n    if (name.endsWith('Geometry')) {\n      props = {\n        attach: 'geometry',\n        ...props\n      };\n    } else if (name.endsWith('Material')) {\n      props = {\n        attach: 'material',\n        ...props\n      };\n    } // It should NOT call onUpdate on object instanciation, because it hasn't been added to the\n    // view yet. If the callback relies on references for instance, they won't be ready yet, this is\n    // why it passes \"true\" here\n\n\n    applyProps(instance, props, {});\n    return instance;\n  }\n\n  function appendChild(parentInstance, child) {\n    if (child) {\n      if (child.isObject3D) {\n        parentInstance.add(child);\n      } else {\n        parentInstance.__r3f.objects.push(child);\n\n        child.parent = parentInstance; // The attach attribute implies that the object attaches itself on the parent\n\n        if (child.attachArray) {\n          if (!is.arr(parentInstance[child.attachArray])) parentInstance[child.attachArray] = [];\n          parentInstance[child.attachArray].push(child);\n        } else if (child.attachObject) {\n          if (!is.obj(parentInstance[child.attachObject[0]])) parentInstance[child.attachObject[0]] = {};\n          parentInstance[child.attachObject[0]][child.attachObject[1]] = child;\n        } else if (child.attach) {\n          parentInstance[child.attach] = child;\n        }\n      }\n\n      updateInstance(child);\n      invalidateInstance(child);\n    }\n  }\n\n  function insertBefore(parentInstance, child, beforeChild) {\n    if (child) {\n      if (child.isObject3D) {\n        child.parent = parentInstance;\n        child.dispatchEvent({\n          type: 'added'\n        });\n        const restSiblings = parentInstance.children.filter(sibling => sibling !== child); // TODO: the order is out of whack if data objects are present, has to be recalculated\n\n        const index = restSiblings.indexOf(beforeChild);\n        parentInstance.children = [...restSiblings.slice(0, index), child, ...restSiblings.slice(index)];\n        updateInstance(child);\n      } else {\n        appendChild(parentInstance, child);\n      } // TODO: order!!!\n\n\n      invalidateInstance(child);\n    }\n  }\n\n  function removeRecursive(array, parent, dispose = false) {\n    if (array) [...array].forEach(child => removeChild(parent, child, dispose));\n  }\n\n  function removeChild(parentInstance, child, dispose) {\n    if (child) {\n      var _child$__r3f2;\n\n      if (child.isObject3D) {\n        var _child$__r3f;\n\n        parentInstance.remove(child); // Remove interactivity\n\n        if ((_child$__r3f = child.__r3f) != null && _child$__r3f.root) {\n          removeInteractivity(child.__r3f.root, child);\n        }\n      } else {\n        child.parent = null;\n        if (parentInstance.__r3f.objects) parentInstance.__r3f.objects = parentInstance.__r3f.objects.filter(x => x !== child); // Remove attachment\n\n        if (child.attachArray) {\n          parentInstance[child.attachArray] = parentInstance[child.attachArray].filter(x => x !== child);\n        } else if (child.attachObject) {\n          delete parentInstance[child.attachObject[0]][child.attachObject[1]];\n        } else if (child.attach) {\n          parentInstance[child.attach] = null;\n        }\n      } // Allow objects to bail out of recursive dispose alltogether by passing dispose={null}\n      // Never dispose of primitives because their state may be kept outside of React!\n      // In order for an object to be able to dispose it has to have\n      //   - a dispose method,\n      //   - it cannot be an <instance object={...} />\n      //   - it cannot be a THREE.Scene, because three has broken it's own api\n      //\n      // Since disposal is recursive, we can check the optional dispose arg, which will be undefined\n      // when the reconciler calls it, but then carry our own check recursively\n\n\n      const isInstance = (_child$__r3f2 = child.__r3f) == null ? void 0 : _child$__r3f2.instance;\n      const shouldDispose = dispose === undefined ? child.dispose !== null && !isInstance : dispose; // Remove nested child objects. Primitives should not have objects and children that are\n      // attached to them declaratively ...\n\n      if (!isInstance) {\n        var _child$__r3f3;\n\n        removeRecursive((_child$__r3f3 = child.__r3f) == null ? void 0 : _child$__r3f3.objects, child, shouldDispose);\n        removeRecursive(child.children, child, shouldDispose);\n      } // Remove references\n\n\n      if (child.__r3f) {\n        delete child.__r3f.root;\n        delete child.__r3f.objects;\n        delete child.__r3f.handlers;\n        delete child.__r3f.memoizedProps;\n        delete child.__r3f;\n      } // Dispose item whenever the reconciler feels like it\n\n\n      if (shouldDispose && child.dispose && child.type !== 'Scene') {\n        unstable_runWithPriority(unstable_IdlePriority, () => child.dispose());\n      }\n\n      invalidateInstance(parentInstance);\n    }\n  }\n\n  function switchInstance(instance, type, newProps, fiber) {\n    const parent = instance.parent;\n    if (!parent) return;\n    const newInstance = createInstance(type, newProps, instance.__r3f.root);\n    removeChild(parent, instance);\n    appendChild(parent, newInstance) // This evil hack switches the react-internal fiber node\n    // https://github.com/facebook/react/issues/14983\n    // https://github.com/facebook/react/pull/15021\n    ;\n    [fiber, fiber.alternate].forEach(fiber => {\n      if (fiber !== null) {\n        fiber.stateNode = newInstance;\n\n        if (fiber.ref) {\n          if (typeof fiber.ref === 'function') fiber.ref(newInstance);else fiber.ref.current = newInstance;\n        }\n      }\n    });\n  }\n\n  const reconciler = Reconciler({\n    now: unstable_now,\n    createInstance,\n    removeChild,\n    appendChild,\n    appendInitialChild: appendChild,\n    insertBefore,\n    warnsIfNotActing: true,\n    supportsMutation: true,\n    isPrimaryRenderer: false,\n    // @ts-ignore\n    scheduleTimeout: is.fun(setTimeout) ? setTimeout : undefined,\n    // @ts-ignore\n    cancelTimeout: is.fun(clearTimeout) ? clearTimeout : undefined,\n    // @ts-ignore\n    setTimeout: is.fun(setTimeout) ? setTimeout : undefined,\n    // @ts-ignore\n    clearTimeout: is.fun(clearTimeout) ? clearTimeout : undefined,\n    noTimeout: -1,\n    appendChildToContainer: (parentInstance, child) => {\n      const {\n        container,\n        root\n      } = getContainer(parentInstance, child); // Link current root to the default scene\n\n      container.__r3f.root = root;\n      appendChild(container, child);\n    },\n    removeChildFromContainer: (parentInstance, child) => {\n      const {\n        container\n      } = getContainer(parentInstance, child);\n      removeChild(container, child);\n    },\n    insertInContainerBefore: (parentInstance, child, beforeChild) => {\n      const {\n        container\n      } = getContainer(parentInstance, child);\n      insertBefore(container, child, beforeChild);\n    },\n\n    commitUpdate(instance, updatePayload, type, oldProps, newProps, fiber) {\n      if (instance.__r3f.instance && newProps.object && newProps.object !== instance) {\n        // <instance object={...} /> where the object reference has changed\n        switchInstance(instance, type, newProps, fiber);\n      } else {\n        // This is a data object, let's extract critical information about it\n        const {\n          args: argsNew = [],\n          ...restNew\n        } = newProps;\n        const {\n          args: argsOld = [],\n          ...restOld\n        } = oldProps; // If it has new props or arguments, then it needs to be re-instanciated\n\n        const hasNewArgs = argsNew.some((value, index) => is.obj(value) ? Object.entries(value).some(([key, val]) => val !== argsOld[index][key]) : value !== argsOld[index]);\n\n        if (hasNewArgs) {\n          // Next we create a new instance and append it again\n          switchInstance(instance, type, newProps, fiber);\n        } else {\n          // Otherwise just overwrite props\n          applyProps(instance, restNew, restOld, true);\n        }\n      }\n    },\n\n    hideInstance(instance) {\n      if (instance.isObject3D) {\n        instance.visible = false;\n        invalidateInstance(instance);\n      }\n    },\n\n    unhideInstance(instance, props) {\n      if (instance.isObject3D && props.visible == null || props.visible) {\n        instance.visible = true;\n        invalidateInstance(instance);\n      }\n    },\n\n    hideTextInstance() {\n      throw new Error('Text is not allowed in the R3F tree.');\n    },\n\n    getPublicInstance(instance) {\n      // TODO: might fix switchInstance (?)\n      return instance;\n    },\n\n    getRootHostContext(rootContainer) {\n      return EMPTY;\n    },\n\n    getChildHostContext(parentHostContext) {\n      return EMPTY;\n    },\n\n    createTextInstance() {},\n\n    finalizeInitialChildren(instance) {\n      // https://github.com/facebook/react/issues/20271\n      // Returning true will trigger commitMount\n      return !!instance.__r3f.handlers;\n    },\n\n    commitMount(instance)\n    /*, type, props*/\n    {\n      // https://github.com/facebook/react/issues/20271\n      // This will make sure events are only added once to the central container\n      if (instance.raycast && instance.__r3f.handlers) instance.__r3f.root.getState().internal.interaction.push(instance);\n    },\n\n    prepareUpdate() {\n      return EMPTY;\n    },\n\n    shouldDeprioritizeSubtree() {\n      return false;\n    },\n\n    prepareForCommit() {\n      return null;\n    },\n\n    preparePortalMount(...args) {// noop\n    },\n\n    resetAfterCommit() {// noop\n    },\n\n    shouldSetTextContent() {\n      return false;\n    },\n\n    clearContainer() {\n      return false;\n    }\n\n  });\n  return {\n    reconciler,\n    applyProps\n  };\n}\n\nconst isRenderer = def => def && !!def.render;\n\nconst isOrthographicCamera = def => def && def.isOrthographicCamera;\n\nconst context = /*#__PURE__*/React.createContext(null);\n\nconst createStore = (applyProps, invalidate, advance, props) => {\n  const {\n    gl,\n    size,\n    shadows = false,\n    linear = false,\n    flat = false,\n    vr = false,\n    orthographic = false,\n    frameloop = 'always',\n    dpr = 1,\n    performance,\n    clock = new THREE.Clock(),\n    raycaster: raycastOptions,\n    camera: cameraOptions,\n    onPointerMissed\n  } = props; // Set shadowmap\n\n  if (shadows) {\n    gl.shadowMap.enabled = true;\n    if (typeof shadows === 'object') Object.assign(gl.shadowMap, shadows);else gl.shadowMap.type = THREE.PCFSoftShadowMap;\n  } // Set color management\n\n\n  if (!linear) {\n    if (!flat) gl.toneMapping = THREE.ACESFilmicToneMapping;\n    gl.outputEncoding = THREE.sRGBEncoding;\n  }\n\n  const rootState = create((set, get) => {\n    // Create custom raycaster\n    const raycaster = new THREE.Raycaster();\n    const {\n      params,\n      ...options\n    } = raycastOptions || {};\n    applyProps(raycaster, {\n      enabled: true,\n      ...options,\n      params: { ...raycaster.params,\n        ...params\n      }\n    }, {}); // Create default camera\n\n    const isCamera = cameraOptions instanceof THREE.Camera;\n    const camera = isCamera ? cameraOptions : orthographic ? new THREE.OrthographicCamera(0, 0, 0, 0, 0.1, 1000) : new THREE.PerspectiveCamera(75, 0, 0.1, 1000);\n\n    if (!isCamera) {\n      camera.position.z = 5;\n      if (cameraOptions) applyProps(camera, cameraOptions, {}); // Always look at center by default\n\n      camera.lookAt(0, 0, 0);\n    }\n\n    function setDpr(dpr) {\n      return Array.isArray(dpr) ? Math.min(Math.max(dpr[0], window.devicePixelRatio), dpr[1]) : dpr;\n    }\n\n    const initialDpr = setDpr(dpr);\n    const position = new THREE.Vector3();\n    const defaultTarget = new THREE.Vector3();\n\n    function getCurrentViewport(camera = get().camera, target = defaultTarget, size = get().size) {\n      const {\n        width,\n        height\n      } = size;\n      const aspect = width / height;\n      const distance = camera.getWorldPosition(position).distanceTo(target);\n\n      if (isOrthographicCamera(camera)) {\n        return {\n          width: width / camera.zoom,\n          height: height / camera.zoom,\n          factor: 1,\n          distance,\n          aspect\n        };\n      } else {\n        const fov = camera.fov * Math.PI / 180; // convert vertical fov to radians\n\n        const h = 2 * Math.tan(fov / 2) * distance; // visible height\n\n        const w = h * (width / height);\n        return {\n          width: w,\n          height: h,\n          factor: width / w,\n          distance,\n          aspect\n        };\n      }\n    }\n\n    let performanceTimeout = undefined;\n\n    const setPerformanceCurrent = current => set(state => ({\n      performance: { ...state.performance,\n        current\n      }\n    }));\n\n    return {\n      gl,\n      set,\n      get,\n      invalidate: () => invalidate(get()),\n      advance: (timestamp, runGlobalEffects) => advance(timestamp, runGlobalEffects, get()),\n      linear,\n      flat,\n      scene: prepare(new THREE.Scene()),\n      camera,\n      raycaster,\n      clock,\n      mouse: new THREE.Vector2(),\n      vr,\n      frameloop,\n      onPointerMissed,\n      performance: {\n        current: 1,\n        min: 0.5,\n        max: 1,\n        debounce: 200,\n        ...performance,\n        regress: () => {\n          const state = get(); // Clear timeout\n\n          if (performanceTimeout) clearTimeout(performanceTimeout); // Set lower bound performance\n\n          if (state.performance.current !== state.performance.min) setPerformanceCurrent(state.performance.min); // Go back to upper bound performance after a while unless something regresses meanwhile\n\n          performanceTimeout = setTimeout(() => setPerformanceCurrent(get().performance.max), state.performance.debounce);\n        }\n      },\n      size: {\n        width: 0,\n        height: 0\n      },\n      viewport: {\n        initialDpr,\n        dpr: initialDpr,\n        width: 0,\n        height: 0,\n        aspect: 0,\n        distance: 0,\n        factor: 0,\n        getCurrentViewport\n      },\n      setSize: (width, height) => {\n        const size = {\n          width,\n          height\n        };\n        set(state => ({\n          size,\n          viewport: { ...state.viewport,\n            ...getCurrentViewport(camera, defaultTarget, size)\n          }\n        }));\n      },\n      setDpr: dpr => set(state => ({\n        viewport: { ...state.viewport,\n          dpr: setDpr(dpr)\n        }\n      })),\n      events: {\n        connected: false\n      },\n      internal: {\n        active: false,\n        priority: 0,\n        frames: 0,\n        lastProps: props,\n        interaction: [],\n        hovered: new Map(),\n        subscribers: [],\n        captured: undefined,\n        initialClick: [0, 0],\n        initialHits: [],\n        subscribe: (ref, priority = 0) => {\n          set(({\n            internal\n          }) => ({\n            internal: { ...internal,\n              // If this subscription was given a priority, it takes rendering into its own hands\n              // For that reason we switch off automatic rendering and increase the manual flag\n              // As long as this flag is positive (there could be multiple render subscription)\n              // ..there can be no internal rendering at all\n              priority: internal.priority + (priority ? 1 : 0),\n              // Register subscriber and sort layers from lowest to highest, meaning,\n              // highest priority renders last (on top of the other frames)\n              subscribers: [...internal.subscribers, {\n                ref,\n                priority\n              }].sort((a, b) => a.priority - b.priority)\n            }\n          }));\n          return () => {\n            set(({\n              internal\n            }) => ({\n              internal: { ...internal,\n                // Decrease manual flag if this subscription had a priority\n                priority: internal.priority - (priority ? 1 : 0),\n                // Remove subscriber from list\n                subscribers: internal.subscribers.filter(s => s.ref !== ref)\n              }\n            }));\n          };\n        }\n      }\n    };\n  }); // Resize camera and renderer on changes to size and pixelratio\n\n  rootState.subscribe(() => {\n    const {\n      camera,\n      size,\n      viewport,\n      internal\n    } = rootState.getState(); // https://github.com/pmndrs/react-three-fiber/issues/92\n    // Do not mess with the camera if it belongs to the user\n\n    if (!(internal.lastProps.camera instanceof THREE.Camera)) {\n      if (isOrthographicCamera(camera)) {\n        camera.left = size.width / -2;\n        camera.right = size.width / 2;\n        camera.top = size.height / 2;\n        camera.bottom = size.height / -2;\n      } else {\n        camera.aspect = size.width / size.height;\n      }\n\n      camera.updateProjectionMatrix(); // https://github.com/pmndrs/react-three-fiber/issues/178\n      // Update matrix world since the renderer is a frame late\n\n      camera.updateMatrixWorld();\n    } // Update renderer\n\n\n    gl.setPixelRatio(viewport.dpr);\n    gl.setSize(size.width, size.height);\n  }, state => [state.viewport.dpr, state.size], shallow);\n  const state = rootState.getState(); // Update size\n\n  if (size) state.setSize(size.width, size.height); // Invalidate on any change\n\n  rootState.subscribe(state => invalidate(state)); // Return root state\n\n  return rootState;\n};\n\nfunction createSubs(callback, subs) {\n  const index = subs.length;\n  subs.push(callback);\n  return () => void subs.splice(index, 1);\n}\n\nlet i;\nlet globalEffects = [];\nlet globalAfterEffects = [];\nlet globalTailEffects = [];\n\nconst addEffect = callback => createSubs(callback, globalEffects);\n\nconst addAfterEffect = callback => createSubs(callback, globalAfterEffects);\n\nconst addTail = callback => createSubs(callback, globalTailEffects);\n\nfunction run(effects, timestamp) {\n  for (i = 0; i < effects.length; i++) effects[i](timestamp);\n}\n\nfunction render$1(timestamp, state) {\n  // Run local effects\n  const delta = state.clock.getDelta(); // Call subscribers (useFrame)\n\n  for (i = 0; i < state.internal.subscribers.length; i++) state.internal.subscribers[i].ref.current(state, delta); // Render content\n\n\n  if (!state.internal.priority && state.gl.render) state.gl.render(state.scene, state.camera); // Decrease frame count\n\n  state.internal.frames = Math.max(0, state.internal.frames - 1);\n  return state.frameloop === 'always' ? 1 : state.internal.frames;\n}\n\nfunction createLoop(roots) {\n  let running = false;\n  let repeat;\n\n  function loop(timestamp) {\n    running = true;\n    repeat = 0; // Run effects\n\n    run(globalEffects, timestamp); // Render all roots\n\n    roots.forEach(root => {\n      const state = root.store.getState(); // If the frameloop is invalidated, do not run another frame\n\n      if (state.internal.active && (state.frameloop === 'always' || state.internal.frames > 0)) repeat += render$1(timestamp, state);\n    }); // Run after-effects\n\n    run(globalAfterEffects, timestamp); // Keep on looping if anything invalidates the frameloop\n\n    if (repeat > 0) return requestAnimationFrame(loop); // Tail call effects, they are called when rendering stops\n    else run(globalTailEffects, timestamp); // Flag end of operation\n\n    running = false;\n  }\n\n  function invalidate(state) {\n    if (!state) return roots.forEach(root => invalidate(root.store.getState()));\n    if (state.vr || !state.internal.active || state.frameloop === 'never') return; // Increase frames, do not go higher than 60\n\n    state.internal.frames = Math.min(60, state.internal.frames + 1); // If the render-loop isn't active, start it\n\n    if (!running) {\n      running = true;\n      requestAnimationFrame(loop);\n    }\n  }\n\n  function advance(timestamp, runGlobalEffects = true, state) {\n    if (runGlobalEffects) run(globalEffects, timestamp);\n    if (!state) roots.forEach(root => render$1(timestamp, root.store.getState()));else render$1(timestamp, state);\n    if (runGlobalEffects) run(globalAfterEffects, timestamp);\n  }\n\n  return {\n    loop,\n    invalidate,\n    advance\n  };\n}\n\nfunction createPointerEvents(store) {\n  const {\n    handlePointer\n  } = createEvents(store);\n  const names = {\n    onClick: 'click',\n    onContextMenu: 'contextmenu',\n    onDoubleClick: 'dblclick',\n    onWheel: 'wheel',\n    onPointerDown: 'pointerdown',\n    onPointerUp: 'pointerup',\n    onPointerLeave: 'pointerleave',\n    onPointerMove: 'pointermove',\n    onPointerCancel: 'pointercancel',\n    onLostPointerCapture: 'lostpointercapture'\n  };\n  return {\n    connected: false,\n    handlers: Object.keys(names).reduce((acc, key) => ({ ...acc,\n      [key]: handlePointer(key)\n    }), {}),\n    connect: target => {\n      var _events$handlers;\n\n      const {\n        set,\n        events\n      } = store.getState();\n      events.disconnect == null ? void 0 : events.disconnect();\n      set(state => ({\n        events: { ...state.events,\n          connected: target\n        }\n      }));\n      Object.entries((_events$handlers = events == null ? void 0 : events.handlers) != null ? _events$handlers : []).forEach(([name, event]) => target.addEventListener(names[name], event, {\n        passive: true\n      }));\n    },\n    disconnect: () => {\n      const {\n        set,\n        events\n      } = store.getState();\n\n      if (events.connected) {\n        var _events$handlers2;\n\n        Object.entries((_events$handlers2 = events.handlers) != null ? _events$handlers2 : []).forEach(([name, event]) => {\n          if (events && events.connected instanceof HTMLElement) {\n            events.connected.removeEventListener(names[name], event);\n          }\n        });\n        set(state => ({\n          events: { ...state.events,\n            connected: false\n          }\n        }));\n      }\n    }\n  };\n} // React currently throws a warning when using useLayoutEffect on the server.\n// To get around it, we can conditionally useEffect on the server (no-op) and\n// useLayoutEffect in the browser.\n\n\nconst useIsomorphicLayoutEffect = typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect;\n\nfunction Canvas({\n  children,\n  tabIndex,\n  resize,\n  id,\n  style,\n  className,\n  events,\n  ...props\n}) {\n  const [ref, size] = useMeasure({\n    scroll: true,\n    debounce: {\n      scroll: 50,\n      resize: 0\n    },\n    ...resize\n  });\n  const canvas = React.useRef(null);\n  useIsomorphicLayoutEffect(() => {\n    if (size.width > 0 && size.height > 0) {\n      render(children, canvas.current, { ...props,\n        size,\n        events: events || createPointerEvents\n      });\n    }\n  }, [size, children]);\n  React.useEffect(() => {\n    const container = canvas.current;\n    return () => unmountComponentAtNode(container);\n  }, []);\n  return /*#__PURE__*/React.createElement(\"div\", {\n    ref: ref,\n    id: id,\n    className: className,\n    tabIndex: tabIndex,\n    style: {\n      position: 'relative',\n      width: '100%',\n      height: '100%',\n      overflow: 'hidden',\n      ...style\n    }\n  }, /*#__PURE__*/React.createElement(\"canvas\", {\n    ref: canvas,\n    style: {\n      display: 'block'\n    }\n  }));\n}\n\nfunction useThree(selector = state => state, equalityFn) {\n  const useStore = React.useContext(context);\n  if (!useStore) throw `R3F hooks can only be used within the Canvas component!`;\n  return useStore(selector, equalityFn);\n}\n\nfunction useFrame(callback, renderPriority = 0) {\n  const {\n    subscribe\n  } = React.useContext(context).getState().internal; // Update ref\n\n  const ref = React.useRef(callback);\n  React.useLayoutEffect(() => void (ref.current = callback), [callback]); // Subscribe/unsub\n\n  React.useEffect(() => {\n    const unsubscribe = subscribe(ref, renderPriority);\n    return () => unsubscribe();\n  }, [renderPriority, subscribe]);\n  return null;\n}\n\nfunction buildGraph(object) {\n  const data = {\n    nodes: {},\n    materials: {}\n  };\n\n  if (object) {\n    object.traverse(obj => {\n      if (obj.name) {\n        data.nodes[obj.name] = obj;\n      }\n\n      if (obj.material && !data.materials[obj.material.name]) {\n        data.materials[obj.material.name] = obj.material;\n      }\n    });\n  }\n\n  return data;\n}\n\nfunction useGraph(object) {\n  return React.useMemo(() => buildGraph(object), [object]);\n}\n\nfunction loadingFn(extensions, onProgress) {\n  return function (Proto, ...input) {\n    // Construct new loader and run extensions\n    const loader = new Proto();\n    if (extensions) extensions(loader); // Go through the urls and load them\n\n    return Promise.all(input.map(input => new Promise((res, reject) => loader.load(input, data => {\n      if (data.scene) Object.assign(data, buildGraph(data.scene));\n      res(data);\n    }, onProgress, error => {\n      var _error$message;\n\n      return reject((_error$message = error.message) != null ? _error$message : `failure loading ${input}`);\n    }))));\n  };\n}\n\nfunction useLoader(Proto, input, extensions, onProgress) {\n  // Use suspense to load async assets\n  const keys = Array.isArray(input) ? input : [input];\n  const results = useAsset(loadingFn(extensions, onProgress), Proto, ...keys); // Return the object/s\n\n  return Array.isArray(input) ? results : results[0];\n}\n\nuseLoader.preload = function (Proto, input, extensions) {\n  const keys = Array.isArray(input) ? input : [input];\n  return useAsset.preload(loadingFn(extensions), Proto, ...keys);\n};\n\nconst roots = new Map();\nconst modes = ['legacy', 'blocking', 'concurrent'];\nconst {\n  invalidate,\n  advance\n} = createLoop(roots);\nconst {\n  reconciler,\n  applyProps\n} = createRenderer();\n\nconst createRendererInstance = (gl, canvas) => isRenderer(gl) ? gl : new THREE.WebGLRenderer({\n  powerPreference: 'high-performance',\n  canvas: canvas,\n  antialias: true,\n  alpha: true,\n  ...gl\n});\n\nfunction render(element, canvas, {\n  gl,\n  size,\n  mode = modes[1],\n  events,\n  onCreated,\n  ...props\n} = {}) {\n  var _store; // Allow size to take on container bounds initially\n\n\n  if (!size) {\n    var _canvas$parentElement, _canvas$parentElement2, _canvas$parentElement3, _canvas$parentElement4;\n\n    size = {\n      width: (_canvas$parentElement = (_canvas$parentElement2 = canvas.parentElement) == null ? void 0 : _canvas$parentElement2.clientWidth) != null ? _canvas$parentElement : 0,\n      height: (_canvas$parentElement3 = (_canvas$parentElement4 = canvas.parentElement) == null ? void 0 : _canvas$parentElement4.clientHeight) != null ? _canvas$parentElement3 : 0\n    };\n  }\n\n  let root = roots.get(canvas);\n  let fiber = root == null ? void 0 : root.fiber;\n  let store = root == null ? void 0 : root.store;\n  let state = (_store = store) == null ? void 0 : _store.getState();\n\n  if (fiber && state) {\n    const lastProps = state.internal.lastProps; // When a root was found, see if any fundamental props must be changed or exchanged\n    // Check pixelratio\n\n    if (props.dpr !== undefined && !is.equ(lastProps.dpr, props.dpr)) state.setDpr(props.dpr); // Check size\n\n    if (size !== undefined && !is.equ(lastProps.size, size)) state.setSize(size.width, size.height); // For some props we want to reset the entire root\n    // Changes to the color-space\n\n    const linearChanged = props.linear !== lastProps.linear;\n\n    if (linearChanged) {\n      unmountComponentAtNode(canvas);\n      fiber = undefined;\n    }\n  }\n\n  if (!fiber) {\n    // If no root has been found, make one\n    // Create gl\n    const glRenderer = createRendererInstance(gl, canvas); // Enable VR if requested\n\n    if (props.vr) {\n      glRenderer.xr.enabled = true;\n      glRenderer.setAnimationLoop(timestamp => advance(timestamp, true));\n    } // Create store\n\n\n    store = createStore(applyProps, invalidate, advance, {\n      gl: glRenderer,\n      size,\n      ...props\n    });\n    const state = store.getState();\n    state.get; // Create renderer\n\n    fiber = reconciler.createContainer(store, modes.indexOf(mode), false, null); // Map it\n\n    roots.set(canvas, {\n      fiber,\n      store\n    }); // Store events internally\n\n    if (events) state.set({\n      events: events(store)\n    });\n  }\n\n  if (store && fiber) {\n    reconciler.updateContainer( /*#__PURE__*/React.createElement(Provider, {\n      store: store,\n      element: element,\n      onCreated: onCreated,\n      target: canvas\n    }), fiber, null, () => undefined);\n    return store;\n  } else {\n    throw 'Error creating root!';\n  }\n}\n\nfunction Provider({\n  store,\n  element,\n  onCreated,\n  target\n}) {\n  React.useEffect(() => {\n    const state = store.getState(); // Flag the canvas active, rendering will now begin\n\n    state.set(state => ({\n      internal: { ...state.internal,\n        active: true\n      }\n    })); // Connect events\n\n    state.events.connect == null ? void 0 : state.events.connect(target); // Notifiy that init is completed, the scene graph exists, but nothing has yet rendered\n\n    if (onCreated) onCreated(state);\n  }, []);\n  return /*#__PURE__*/React.createElement(context.Provider, {\n    value: store\n  }, element);\n}\n\nfunction unmountComponentAtNode(canvas, callback) {\n  const root = roots.get(canvas);\n  const fiber = root == null ? void 0 : root.fiber;\n\n  if (fiber) {\n    const state = root == null ? void 0 : root.store.getState();\n    if (state) state.internal.active = false;\n    reconciler.updateContainer(null, fiber, null, () => {\n      if (state) {\n        setTimeout(() => {\n          var _state$gl, _state$gl$renderLists, _state$gl2;\n\n          state.events.disconnect == null ? void 0 : state.events.disconnect();\n          (_state$gl = state.gl) == null ? void 0 : (_state$gl$renderLists = _state$gl.renderLists) == null ? void 0 : _state$gl$renderLists.dispose == null ? void 0 : _state$gl$renderLists.dispose();\n          (_state$gl2 = state.gl) == null ? void 0 : _state$gl2.forceContextLoss == null ? void 0 : _state$gl2.forceContextLoss();\n          dispose(state);\n          roots.delete(canvas);\n          if (callback) callback(canvas);\n        }, 500);\n      }\n    });\n  }\n}\n\nfunction dispose(obj) {\n  if (obj.dispose && obj.type !== 'Scene') obj.dispose();\n\n  for (const p in obj) {\n    var _dispose, _ref;\n\n    (_dispose = (_ref = p).dispose) == null ? void 0 : _dispose.call(_ref);\n    delete obj[p];\n  }\n}\n\nconst act = reconciler.act;\nconst hasSymbol = is.fun(Symbol) && Symbol.for;\nconst REACT_PORTAL_TYPE = hasSymbol ? Symbol.for('react.portal') : 0xeaca;\n\nfunction createPortal(children, container, implementation, key = null) {\n  return {\n    $$typeof: REACT_PORTAL_TYPE,\n    key: key == null ? null : '' + key,\n    children,\n    containerInfo: prepare(container),\n    implementation\n  };\n}\n\nreconciler.injectIntoDevTools({\n  bundleType: process.env.NODE_ENV === 'production' ? 0 : 1,\n  rendererPackageName: '@react-three/fiber',\n  version: '17.0.2'\n});\nexport { Canvas, threeTypes as ReactThreeFiber, roots as _roots, act, addAfterEffect, addEffect, addTail, advance, applyProps, context, createPortal, dispose, createPointerEvents as events, extend, invalidate, reconciler, render, unmountComponentAtNode, useFrame, useGraph, useLoader, useThree };","map":{"version":3,"sources":["C:/Users/houss/desktop/wayz/node_modules/@react-three/fiber/dist/react-three-fiber.esm.js"],"names":["THREE","React","create","shallow","Reconciler","unstable_now","unstable_runWithPriority","unstable_IdlePriority","useAsset","useMeasure","threeTypes","Object","freeze","__proto__","is","obj","a","arr","fun","str","num","und","Array","isArray","equ","b","i","makeId","event","eventObject","object","uuid","index","removeInteractivity","store","internal","getState","interaction","filter","o","initialHits","hovered","forEach","value","key","delete","createEvents","temp","Vector3","prepareRay","_raycaster$computeOff","state","raycaster","mouse","camera","size","offsetX","offsetY","computeOffsets","width","height","set","setFromCamera","calculateDistance","dx","initialClick","dy","Math","round","sqrt","filterPointerEvents","objects","some","name","_r3f$handlers","__r3f","handlers","intersect","enabled","seen","Set","intersections","eventsObjects","intersects","intersectObjects","item","id","has","add","_r3f","push","parent","patchIntersects","captured","type","find","hit","handleIntersects","callback","length","unprojectedPoint","x","y","unproject","delta","releasePointerCapture","target","localState","stopped","setPointerCapture","extractEventProps","prop","getPrototypeOf","raycastEvent","ray","stopPropagation","cap","h","from","values","higher","slice","indexOf","cancelPointer","currentTarget","sourceEvent","hits","hoveredObj","data","onPointerOut","onPointerLeave","handlePointer","undefined","onPointerMissed","isPointerMove","onPointerOver","onPointerEnter","hoveredItem","get","onPointerMove","handler","includes","pointerMissed","map","_r3f$handlers2","isStore","def","getContainer","container","child","_container$__r3f$root","_container$__r3f","root","scene","DEFAULT","EMPTY","FILTER","catalogue","extend","prepare","instance","memoizedProps","createRenderer","roots","applyProps","newProps","oldProps","accumulative","_instance$__r3f","_root$getState","_instance$__r3f2","rootState","sameProps","newMemoizedProps","entries","entry","args","attach","objectKeys","keys","test","leftOvers","hasOwnProperty","toFilter","filteredProps","filteredPropsEntries","unshift","currentInstance","targetProp","split","reduce","acc","reverseEntries","reverse","constructor","defaultClassCall","dispose","copy","Layers","fromArray","isColor","Color","setScalar","mask","linear","convertSRGBToLinear","Texture","encoding","sRGBEncoding","invalidateInstance","raycast","splice","updateInstance","_instance$__r3f3","_instance$__r3f3$root","frames","invalidate","onUpdate","createInstance","props","hostContext","internalInstanceHandle","toUpperCase","fn","node","return","stateNode","containerInfo","isArgsArr","endsWith","appendChild","parentInstance","isObject3D","attachArray","attachObject","insertBefore","beforeChild","dispatchEvent","restSiblings","children","sibling","removeRecursive","array","removeChild","_child$__r3f2","_child$__r3f","remove","isInstance","shouldDispose","_child$__r3f3","switchInstance","fiber","newInstance","alternate","ref","current","reconciler","now","appendInitialChild","warnsIfNotActing","supportsMutation","isPrimaryRenderer","scheduleTimeout","setTimeout","cancelTimeout","clearTimeout","noTimeout","appendChildToContainer","removeChildFromContainer","insertInContainerBefore","commitUpdate","updatePayload","argsNew","restNew","argsOld","restOld","hasNewArgs","val","hideInstance","visible","unhideInstance","hideTextInstance","Error","getPublicInstance","getRootHostContext","rootContainer","getChildHostContext","parentHostContext","createTextInstance","finalizeInitialChildren","commitMount","prepareUpdate","shouldDeprioritizeSubtree","prepareForCommit","preparePortalMount","resetAfterCommit","shouldSetTextContent","clearContainer","isRenderer","render","isOrthographicCamera","context","createContext","createStore","advance","gl","shadows","flat","vr","orthographic","frameloop","dpr","performance","clock","Clock","raycastOptions","cameraOptions","shadowMap","assign","PCFSoftShadowMap","toneMapping","ACESFilmicToneMapping","outputEncoding","Raycaster","params","options","isCamera","Camera","OrthographicCamera","PerspectiveCamera","position","z","lookAt","setDpr","min","max","window","devicePixelRatio","initialDpr","defaultTarget","getCurrentViewport","aspect","distance","getWorldPosition","distanceTo","zoom","factor","fov","PI","tan","w","performanceTimeout","setPerformanceCurrent","timestamp","runGlobalEffects","Scene","Vector2","debounce","regress","viewport","setSize","events","connected","active","priority","lastProps","Map","subscribers","subscribe","sort","s","left","right","top","bottom","updateProjectionMatrix","updateMatrixWorld","setPixelRatio","createSubs","subs","globalEffects","globalAfterEffects","globalTailEffects","addEffect","addAfterEffect","addTail","run","effects","render$1","getDelta","createLoop","running","repeat","loop","requestAnimationFrame","createPointerEvents","names","onClick","onContextMenu","onDoubleClick","onWheel","onPointerDown","onPointerUp","onPointerCancel","onLostPointerCapture","connect","_events$handlers","disconnect","addEventListener","passive","_events$handlers2","HTMLElement","removeEventListener","useIsomorphicLayoutEffect","useLayoutEffect","useEffect","Canvas","tabIndex","resize","style","className","scroll","canvas","useRef","unmountComponentAtNode","createElement","overflow","display","useThree","selector","equalityFn","useStore","useContext","useFrame","renderPriority","unsubscribe","buildGraph","nodes","materials","traverse","material","useGraph","useMemo","loadingFn","extensions","onProgress","Proto","input","loader","Promise","all","res","reject","load","error","_error$message","message","useLoader","results","preload","modes","createRendererInstance","WebGLRenderer","powerPreference","antialias","alpha","element","mode","onCreated","_store","_canvas$parentElement","_canvas$parentElement2","_canvas$parentElement3","_canvas$parentElement4","parentElement","clientWidth","clientHeight","linearChanged","glRenderer","xr","setAnimationLoop","createContainer","updateContainer","Provider","_state$gl","_state$gl$renderLists","_state$gl2","renderLists","forceContextLoss","p","_dispose","_ref","call","act","hasSymbol","Symbol","for","REACT_PORTAL_TYPE","createPortal","implementation","$$typeof","injectIntoDevTools","bundleType","process","env","NODE_ENV","rendererPackageName","version","ReactThreeFiber","_roots"],"mappings":"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","sourcesContent":["import * as THREE from 'three';\r\nimport * as React from 'react';\r\nimport create from 'zustand';\r\nimport shallow from 'zustand/shallow';\r\nimport Reconciler from 'react-reconciler';\r\nimport { unstable_now, unstable_runWithPriority, unstable_IdlePriority } from 'scheduler';\r\nimport { useAsset } from 'use-asset';\r\nimport useMeasure from 'react-use-measure';\r\n\r\nvar threeTypes = /*#__PURE__*/Object.freeze({\r\n  __proto__: null\r\n});\r\n\r\nconst is = {\r\n  obj: a => a === Object(a) && !is.arr(a) && typeof a !== 'function',\r\n  fun: a => typeof a === 'function',\r\n  str: a => typeof a === 'string',\r\n  num: a => typeof a === 'number',\r\n  und: a => a === void 0,\r\n  arr: a => Array.isArray(a),\r\n\r\n  equ(a, b) {\r\n    // Wrong type or one of the two undefined, doesn't match\r\n    if (typeof a !== typeof b || !!a !== !!b) return false; // Atomic, just compare a against b\r\n\r\n    if (is.str(a) || is.num(a) || is.obj(a)) return a === b; // Array, shallow compare first to see if it's a match\r\n\r\n    if (is.arr(a) && a == b) return true; // Last resort, go through keys\r\n\r\n    let i;\r\n\r\n    for (i in a) if (!(i in b)) return false;\r\n\r\n    for (i in b) if (a[i] !== b[i]) return false;\r\n\r\n    return is.und(i) ? a === b : true;\r\n  }\r\n\r\n};\r\n\r\nfunction makeId(event) {\r\n  return (event.eventObject || event.object).uuid + '/' + event.index;\r\n}\r\n\r\nfunction removeInteractivity(store, object) {\r\n  const {\r\n    internal\r\n  } = store.getState(); // Removes every trace of an object from the data store\r\n\r\n  internal.interaction = internal.interaction.filter(o => o !== object);\r\n  internal.initialHits = internal.initialHits.filter(o => o !== object);\r\n  internal.hovered.forEach((value, key) => {\r\n    if (value.eventObject === object || value.object === object) {\r\n      internal.hovered.delete(key);\r\n    }\r\n  });\r\n}\r\nfunction createEvents(store) {\r\n  const temp = new THREE.Vector3();\r\n  /** Sets up defaultRaycaster */\r\n\r\n  function prepareRay(event) {\r\n    var _raycaster$computeOff;\r\n\r\n    const state = store.getState();\r\n    const {\r\n      raycaster,\r\n      mouse,\r\n      camera,\r\n      size\r\n    } = state; // https://github.com/pmndrs/react-three-fiber/pull/782\r\n    // Events trigger outside of canvas when moved\r\n\r\n    const {\r\n      offsetX,\r\n      offsetY\r\n    } = (_raycaster$computeOff = raycaster.computeOffsets == null ? void 0 : raycaster.computeOffsets(event, state)) != null ? _raycaster$computeOff : event;\r\n    const {\r\n      width,\r\n      height\r\n    } = size;\r\n    mouse.set(offsetX / width * 2 - 1, -(offsetY / height) * 2 + 1);\r\n    raycaster.setFromCamera(mouse, camera);\r\n  }\r\n  /** Calculates delta */\r\n\r\n\r\n  function calculateDistance(event) {\r\n    const {\r\n      internal\r\n    } = store.getState();\r\n    const dx = event.offsetX - internal.initialClick[0];\r\n    const dy = event.offsetY - internal.initialClick[1];\r\n    return Math.round(Math.sqrt(dx * dx + dy * dy));\r\n  }\r\n  /** Returns true if an instance has a valid pointer-event registered, this excludes scroll, clicks etc */\r\n\r\n\r\n  function filterPointerEvents(objects) {\r\n    return objects.filter(obj => ['Move', 'Over', 'Enter', 'Out', 'Leave'].some(name => {\r\n      var _r3f$handlers;\r\n\r\n      return (_r3f$handlers = obj.__r3f.handlers) == null ? void 0 : _r3f$handlers['onPointer' + name];\r\n    }));\r\n  }\r\n\r\n  function intersect(filter) {\r\n    const state = store.getState();\r\n    const {\r\n      raycaster,\r\n      internal\r\n    } = state; // Skip event handling when noEvents is set\r\n\r\n    if (!raycaster.enabled) return [];\r\n    const seen = new Set();\r\n    const intersections = []; // Allow callers to eliminate event objects\r\n\r\n    const eventsObjects = filter ? filter(internal.interaction) : internal.interaction; // Intersect known handler objects and filter against duplicates\r\n\r\n    let intersects = raycaster.intersectObjects(eventsObjects, true).filter(item => {\r\n      const id = makeId(item);\r\n      if (seen.has(id)) return false;\r\n      seen.add(id);\r\n      return true;\r\n    }); // https://github.com/mrdoob/three.js/issues/16031\r\n    // Allow custom userland intersect sort order\r\n\r\n    if (raycaster.filter) intersects = raycaster.filter(intersects, state);\r\n\r\n    for (const intersect of intersects) {\r\n      let eventObject = intersect.object; // Bubble event up\r\n\r\n      while (eventObject) {\r\n        var _r3f;\r\n\r\n        const handlers = (_r3f = eventObject.__r3f) == null ? void 0 : _r3f.handlers;\r\n        if (handlers) intersections.push({ ...intersect,\r\n          eventObject\r\n        });\r\n        eventObject = eventObject.parent;\r\n      }\r\n    }\r\n\r\n    return intersections;\r\n  }\r\n  /**  Creates filtered intersects and returns an array of positive hits */\r\n\r\n\r\n  function patchIntersects(intersections, event) {\r\n    const {\r\n      internal\r\n    } = store.getState(); // If the interaction is captured take that into account, the captured event has to be part of the intersects\r\n\r\n    if (internal.captured && event.type !== 'click' && event.type !== 'wheel') {\r\n      internal.captured.forEach(captured => {\r\n        if (!intersections.find(hit => hit.eventObject === captured.eventObject)) intersections.push(captured);\r\n      });\r\n    }\r\n\r\n    return intersections;\r\n  }\r\n  /**  Handles intersections by forwarding them to handlers */\r\n\r\n\r\n  function handleIntersects(intersections, event, callback) {\r\n    const {\r\n      raycaster,\r\n      mouse,\r\n      camera,\r\n      internal\r\n    } = store.getState(); // If anything has been found, forward it to the event listeners\r\n\r\n    if (intersections.length) {\r\n      const unprojectedPoint = temp.set(mouse.x, mouse.y, 0).unproject(camera);\r\n      const delta = event.type === 'click' ? calculateDistance(event) : 0;\r\n\r\n      const releasePointerCapture = id => event.target.releasePointerCapture(id);\r\n\r\n      const localState = {\r\n        stopped: false,\r\n        captured: false\r\n      };\r\n\r\n      for (const hit of intersections) {\r\n        const setPointerCapture = id => {\r\n          // If the hit is going to be captured flag that we're in captured state\r\n          if (!localState.captured) {\r\n            localState.captured = true; // The captured hit array is reset to collect hits\r\n\r\n            internal.captured = [];\r\n          } // Push hits to the array\r\n\r\n\r\n          if (internal.captured) internal.captured.push(hit) // Call the original event now\r\n          ;\r\n          event.target.setPointerCapture(id);\r\n        }; // Add native event props\r\n\r\n\r\n        let extractEventProps = {};\r\n\r\n        for (let prop in Object.getPrototypeOf(event)) {\r\n          extractEventProps[prop] = event[prop];\r\n        }\r\n\r\n        let raycastEvent = { ...hit,\r\n          ...extractEventProps,\r\n          intersections,\r\n          stopped: localState.stopped,\r\n          delta,\r\n          unprojectedPoint,\r\n          ray: raycaster.ray,\r\n          camera: camera,\r\n          // Hijack stopPropagation, which just sets a flag\r\n          stopPropagation: () => {\r\n            // https://github.com/pmndrs/react-three-fiber/issues/596\r\n            // Events are not allowed to stop propagation if the pointer has been captured\r\n            const cap = internal.captured;\r\n\r\n            if (!cap || cap.find(h => h.eventObject.id === hit.eventObject.id)) {\r\n              raycastEvent.stopped = localState.stopped = true; // Propagation is stopped, remove all other hover records\r\n              // An event handler is only allowed to flush other handlers if it is hovered itself\r\n\r\n              if (internal.hovered.size && Array.from(internal.hovered.values()).find(i => i.eventObject === hit.eventObject)) {\r\n                // Objects cannot flush out higher up objects that have already caught the event\r\n                const higher = intersections.slice(0, intersections.indexOf(hit));\r\n                cancelPointer([...higher, hit]);\r\n              }\r\n            }\r\n          },\r\n          target: { ...event.target,\r\n            setPointerCapture,\r\n            releasePointerCapture\r\n          },\r\n          currentTarget: { ...event.currentTarget,\r\n            setPointerCapture,\r\n            releasePointerCapture\r\n          },\r\n          sourceEvent: event\r\n        }; // Call subscribers\r\n\r\n        callback(raycastEvent); // Event bubbling may be interrupted by stopPropagation\r\n\r\n        if (localState.stopped === true) break;\r\n      }\r\n    }\r\n\r\n    return intersections;\r\n  }\r\n\r\n  function cancelPointer(hits) {\r\n    const {\r\n      internal\r\n    } = store.getState();\r\n    Array.from(internal.hovered.values()).forEach(hoveredObj => {\r\n      // When no objects were hit or the the hovered object wasn't found underneath the cursor\r\n      // we call onPointerOut and delete the object from the hovered-elements map\r\n      if (!hits.length || !hits.find(hit => hit.object === hoveredObj.object && hit.index === hoveredObj.index)) {\r\n        const eventObject = hoveredObj.eventObject;\r\n        const handlers = eventObject.__r3f.handlers;\r\n        internal.hovered.delete(makeId(hoveredObj));\r\n\r\n        if (handlers) {\r\n          // Clear out intersects, they are outdated by now\r\n          const data = { ...hoveredObj,\r\n            intersections: hits || []\r\n          };\r\n          handlers.onPointerOut == null ? void 0 : handlers.onPointerOut(data);\r\n          handlers.onPointerLeave == null ? void 0 : handlers.onPointerLeave(data);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  const handlePointer = name => {\r\n    // Deal with cancelation\r\n    switch (name) {\r\n      case 'onPointerLeave':\r\n      case 'onPointerCancel':\r\n        return () => cancelPointer([]);\r\n\r\n      case 'onLostPointerCapture':\r\n        return () => (store.getState().internal.captured = undefined, cancelPointer([]));\r\n    } // Any other pointer goes here ...\r\n\r\n\r\n    return event => {\r\n      const {\r\n        onPointerMissed,\r\n        internal\r\n      } = store.getState();\r\n      prepareRay(event); // Get fresh intersects\r\n\r\n      const isPointerMove = name === 'onPointerMove';\r\n      const filter = isPointerMove ? filterPointerEvents : undefined;\r\n      const hits = patchIntersects(intersect(filter), event); // Take care of unhover\r\n\r\n      if (isPointerMove) cancelPointer(hits);\r\n      handleIntersects(hits, event, data => {\r\n        const eventObject = data.eventObject;\r\n        const handlers = eventObject.__r3f.handlers; // Check presence of handlers\r\n\r\n        if (!handlers) return;\r\n\r\n        if (isPointerMove) {\r\n          // Move event ...\r\n          if (handlers.onPointerOver || handlers.onPointerEnter || handlers.onPointerOut || handlers.onPointerLeave) {\r\n            // When enter or out is present take care of hover-state\r\n            const id = makeId(data);\r\n            const hoveredItem = internal.hovered.get(id);\r\n\r\n            if (!hoveredItem) {\r\n              // If the object wasn't previously hovered, book it and call its handler\r\n              internal.hovered.set(id, data);\r\n              handlers.onPointerOver == null ? void 0 : handlers.onPointerOver(data);\r\n              handlers.onPointerEnter == null ? void 0 : handlers.onPointerEnter(data);\r\n            } else if (hoveredItem.stopped) {\r\n              // If the object was previously hovered and stopped, we shouldn't allow other items to proceed\r\n              data.stopPropagation();\r\n            }\r\n          } // Call mouse move\r\n\r\n\r\n          handlers.onPointerMove == null ? void 0 : handlers.onPointerMove(data);\r\n        } else {\r\n          // All other events ...\r\n          const handler = handlers == null ? void 0 : handlers[name];\r\n\r\n          if (handler) {\r\n            // Forward all events back to their respective handlers with the exception of click events,\r\n            // which must use the initial target\r\n            if (name !== 'onClick' && name !== 'onContextMenu' && name !== 'onDoubleClick' || internal.initialHits.includes(eventObject)) {\r\n              handler(data);\r\n              pointerMissed(event, internal.interaction.filter(object => object !== eventObject));\r\n            }\r\n          }\r\n        }\r\n      }); // Save initial coordinates on pointer-down\r\n\r\n      if (name === 'onPointerDown') {\r\n        internal.initialClick = [event.offsetX, event.offsetY];\r\n        internal.initialHits = hits.map(hit => hit.eventObject);\r\n      } // If a click yields no results, pass it back to the user as a miss\r\n\r\n\r\n      if ((name === 'onClick' || name === 'onContextMenu' || name === 'onDoubleClick') && !hits.length) {\r\n        if (calculateDistance(event) <= 2) {\r\n          pointerMissed(event, internal.interaction);\r\n          if (onPointerMissed) onPointerMissed();\r\n        }\r\n      }\r\n    };\r\n  };\r\n\r\n  function pointerMissed(event, objects) {\r\n    objects.forEach(object => {\r\n      var _r3f$handlers2;\r\n\r\n      return (_r3f$handlers2 = object.__r3f.handlers) == null ? void 0 : _r3f$handlers2.onPointerMissed == null ? void 0 : _r3f$handlers2.onPointerMissed(event);\r\n    });\r\n  }\r\n\r\n  return {\r\n    handlePointer\r\n  };\r\n}\r\n\r\n// Type guard to tell a store from a portal\r\nconst isStore = def => def && !!def.getState;\r\n\r\nconst getContainer = (container, child) => {\r\n  var _container$__r3f$root, _container$__r3f;\r\n\r\n  return {\r\n    // If the container is not a root-store then it must be a THREE.Object3D into which part of the\r\n    // scene is portalled into. Now there can be two variants of this, either that object is part of\r\n    // the regular jsx tree, in which case it already has __r3f with a valid root attached, or it lies\r\n    // outside react, in which case we must take the root of the child that is about to be attached to it.\r\n    root: isStore(container) ? container : (_container$__r3f$root = (_container$__r3f = container.__r3f) == null ? void 0 : _container$__r3f.root) != null ? _container$__r3f$root : child.__r3f.root,\r\n    // The container is the eventual target into which objects are mounted, it has to be a THREE.Object3D\r\n    container: isStore(container) ? container.getState().scene : container\r\n  };\r\n};\r\n\r\nconst DEFAULT = '__default';\r\nconst EMPTY = {};\r\nconst FILTER = ['children', 'key', 'ref'];\r\nlet catalogue = {};\r\n\r\nlet extend = objects => void (catalogue = { ...catalogue,\r\n  ...objects\r\n}); // Each object in the scene carries a small LocalState descriptor\r\n\r\n\r\nfunction prepare(object, state) {\r\n  const instance = object;\r\n\r\n  if (!instance.__r3f) {\r\n    instance.__r3f = {\r\n      root: null,\r\n      memoizedProps: {},\r\n      objects: [],\r\n      ...state\r\n    };\r\n  }\r\n\r\n  return object;\r\n}\r\n\r\nfunction createRenderer(roots) {\r\n  function applyProps(instance, newProps, oldProps = {}, accumulative = false) {\r\n    var _instance$__r3f, _root$getState, _instance$__r3f2;\r\n\r\n    // Filter equals, events and reserved props\r\n    const localState = (_instance$__r3f = instance == null ? void 0 : instance.__r3f) != null ? _instance$__r3f : {};\r\n    const root = localState.root;\r\n    const rootState = (_root$getState = root == null ? void 0 : root.getState == null ? void 0 : root.getState()) != null ? _root$getState : {};\r\n    const sameProps = [];\r\n    const handlers = [];\r\n    const newMemoizedProps = {};\r\n    let i = 0;\r\n    Object.entries(newProps).forEach(([key, entry]) => {\r\n      // we don't want children, ref or key in the memoized props\r\n      if (FILTER.indexOf(key) === -1) {\r\n        newMemoizedProps[key] = entry;\r\n      }\r\n    });\r\n\r\n    if (localState.memoizedProps && localState.memoizedProps.args) {\r\n      newMemoizedProps.args = localState.memoizedProps.args;\r\n    }\r\n\r\n    if (localState.memoizedProps && localState.memoizedProps.attach) {\r\n      newMemoizedProps.attach = localState.memoizedProps.attach;\r\n    }\r\n\r\n    if (instance.__r3f) {\r\n      instance.__r3f.memoizedProps = newMemoizedProps;\r\n    }\r\n\r\n    let objectKeys = Object.keys(newProps);\r\n\r\n    for (i = 0; i < objectKeys.length; i++) {\r\n      if (is.equ(newProps[objectKeys[i]], oldProps[objectKeys[i]])) {\r\n        sameProps.push(objectKeys[i]);\r\n      } // Event-handlers ...\r\n      //   are functions, that\r\n      //   start with \"on\", and\r\n      //   contain the name \"Pointer\", \"Click\", \"DoubleClick\", \"ContextMenu\", or \"Wheel\"\r\n\r\n\r\n      if (is.fun(newProps[objectKeys[i]]) && /^on(Pointer|Click|DoubleClick|ContextMenu|Wheel)/.test(objectKeys[i])) {\r\n        handlers.push(objectKeys[i]);\r\n      }\r\n    } // Catch props that existed, but now exist no more ...\r\n\r\n\r\n    const leftOvers = [];\r\n\r\n    if (accumulative) {\r\n      objectKeys = Object.keys(oldProps);\r\n\r\n      for (i = 0; i < objectKeys.length; i++) {\r\n        if (!newProps.hasOwnProperty(objectKeys[i])) {\r\n          leftOvers.push(objectKeys[i]);\r\n        }\r\n      }\r\n    }\r\n\r\n    const toFilter = [...sameProps, ...FILTER]; // Instances use \"object\" as a reserved identifier\r\n\r\n    if ((_instance$__r3f2 = instance.__r3f) != null && _instance$__r3f2.instance) toFilter.push('object');\r\n    const filteredProps = { ...newProps\r\n    }; // Removes sameProps and reserved props from newProps\r\n\r\n    objectKeys = Object.keys(filteredProps);\r\n\r\n    for (i = 0; i < objectKeys.length; i++) {\r\n      if (toFilter.indexOf(objectKeys[i]) > -1) {\r\n        delete filteredProps[objectKeys[i]];\r\n      }\r\n    } // Collect all new props\r\n\r\n\r\n    const filteredPropsEntries = Object.entries(filteredProps); // Prepend left-overs so they can be reset or removed\r\n    // Left-overs must come first!\r\n\r\n    for (i = 0; i < leftOvers.length; i++) {\r\n      if (leftOvers[i] !== 'children') {\r\n        filteredPropsEntries.unshift([leftOvers[i], DEFAULT + 'remove']);\r\n      }\r\n    }\r\n\r\n    if (filteredPropsEntries.length > 0) {\r\n      filteredPropsEntries.forEach(([key, value]) => {\r\n        if (!handlers.includes(key)) {\r\n          let currentInstance = instance;\r\n          let targetProp = currentInstance[key];\r\n\r\n          if (key.includes('-')) {\r\n            const entries = key.split('-');\r\n            targetProp = entries.reduce((acc, key) => acc[key], instance); // If the target is atomic, it forces us to switch the root\r\n\r\n            if (!(targetProp && targetProp.set)) {\r\n              const [name, ...reverseEntries] = entries.reverse();\r\n              currentInstance = reverseEntries.reverse().reduce((acc, key) => acc[key], instance);\r\n              key = name;\r\n            }\r\n          } // https://github.com/mrdoob/three.js/issues/21209\r\n          // HMR/fast-refresh relies on the ability to cancel out props, but threejs\r\n          // has no means to do this. Hence we curate a small collection of value-classes\r\n          // with their respective constructor/set arguments\r\n          // For removed props, try to set default values, if possible\r\n\r\n\r\n          if (value === DEFAULT + 'remove') {\r\n            if (targetProp && targetProp.constructor) {\r\n              // use the prop constructor to find the default it should be\r\n              value = new targetProp.constructor(newMemoizedProps.args);\r\n            } else if (currentInstance.constructor) {\r\n              // create a blank slate of the instance and copy the particular parameter.\r\n              // @ts-ignore\r\n              const defaultClassCall = new currentInstance.constructor(currentInstance.__r3f.memoizedProps.args);\r\n              value = defaultClassCall[targetProp]; // destory the instance\r\n\r\n              if (defaultClassCall.dispose) {\r\n                defaultClassCall.dispose();\r\n              }\r\n            } else {\r\n              // instance does not have constructor, just set it to 0\r\n              value = 0;\r\n            }\r\n          } // Special treatment for objects with support for set/copy, and layers\r\n\r\n\r\n          if (targetProp && targetProp.set && (targetProp.copy || targetProp instanceof THREE.Layers)) {\r\n            // If value is an array\r\n            if (Array.isArray(value)) {\r\n              if (targetProp.fromArray) {\r\n                targetProp.fromArray(value);\r\n              } else {\r\n                targetProp.set(...value);\r\n              }\r\n            } // Test again target.copy(class) next ...\r\n            else if (targetProp.copy && value && value.constructor && targetProp.constructor.name === value.constructor.name) {\r\n                targetProp.copy(value);\r\n              } // If nothing else fits, just set the single value, ignore undefined\r\n              // https://github.com/react-spring/react-three-fiber/issues/274\r\n              else if (value !== undefined) {\r\n                  const isColor = targetProp instanceof THREE.Color; // Allow setting array scalars\r\n\r\n                  if (!isColor && targetProp.setScalar) targetProp.setScalar(value); // Layers have no copy function, we must therefore copy the mask property\r\n                  else if (targetProp instanceof THREE.Layers && value instanceof THREE.Layers) targetProp.mask = value.mask; // Otherwise just set ...\r\n                    else targetProp.set(value); // Auto-convert sRGB colors, for now ...\r\n                  // https://github.com/react-spring/react-three-fiber/issues/344\r\n\r\n                  if (!rootState.linear && isColor) targetProp.convertSRGBToLinear();\r\n                } // Else, just overwrite the value\r\n\r\n          } else {\r\n            currentInstance[key] = value; // Auto-convert sRGB textures, for now ...\r\n            // https://github.com/react-spring/react-three-fiber/issues/344\r\n\r\n            if (!rootState.linear && currentInstance[key] instanceof THREE.Texture) currentInstance[key].encoding = THREE.sRGBEncoding;\r\n          }\r\n\r\n          invalidateInstance(instance);\r\n        }\r\n      }); // Preemptively delete the instance from the containers interaction\r\n\r\n      if (accumulative && root && instance.raycast && localState.handlers) {\r\n        localState.handlers = undefined;\r\n        const index = rootState.internal.interaction.indexOf(instance);\r\n        if (index > -1) rootState.internal.interaction.splice(index, 1);\r\n      } // Prep interaction handlers\r\n\r\n\r\n      if (handlers.length) {\r\n        if (accumulative && root && instance.raycast) {\r\n          rootState.internal.interaction.push(instance);\r\n        } // Add handlers to the instances handler-map\r\n\r\n\r\n        localState.handlers = handlers.reduce((acc, key) => ({ ...acc,\r\n          [key]: newProps[key]\r\n        }), {});\r\n      } // Call the update lifecycle when it is being updated, but only when it is part of the scene\r\n\r\n\r\n      if (instance.parent) updateInstance(instance);\r\n    }\r\n  }\r\n\r\n  function invalidateInstance(instance) {\r\n    var _instance$__r3f3, _instance$__r3f3$root;\r\n\r\n    const state = (_instance$__r3f3 = instance.__r3f) == null ? void 0 : (_instance$__r3f3$root = _instance$__r3f3.root) == null ? void 0 : _instance$__r3f3$root.getState == null ? void 0 : _instance$__r3f3$root.getState();\r\n    if (state && state.internal.frames === 0) state.invalidate();\r\n  }\r\n\r\n  function updateInstance(instance) {\r\n    instance.onUpdate == null ? void 0 : instance.onUpdate(instance);\r\n  }\r\n\r\n  function createInstance(type, {\r\n    args = [],\r\n    ...props\r\n  }, root, hostContext, internalInstanceHandle) {\r\n    let name = `${type[0].toUpperCase()}${type.slice(1)}`;\r\n    let instance; // https://github.com/facebook/react/issues/17147\r\n    // Portals do not give us a root, they are themselves treated as a root by the reconciler\r\n    // In order to figure out the actual root we have to climb through fiber internals :(\r\n\r\n    if (!isStore(root) && internalInstanceHandle) {\r\n      const fn = node => {\r\n        if (!node.return) return node.stateNode && node.stateNode.containerInfo;else return fn(node.return);\r\n      };\r\n\r\n      root = fn(internalInstanceHandle);\r\n    } // Assert that by now we have a valid root\r\n\r\n\r\n    if (!root || !isStore(root)) throw `No valid root for ${name}!`;\r\n\r\n    if (type === 'primitive') {\r\n      if (props.object === undefined) throw `Primitives without 'object' are invalid!`;\r\n      const object = props.object;\r\n      instance = prepare(object, {\r\n        root,\r\n        instance: true\r\n      });\r\n    } else {\r\n      const target = catalogue[name] || THREE[name];\r\n      if (!target) throw `${name} is not part of the THREE namespace! Did you forget to extend? See: https://github.com/pmndrs/react-three-fiber/blob/master/markdown/api.md#using-3rd-party-objects-declaratively`;\r\n      const isArgsArr = is.arr(args); // Instanciate new object, link it to the root\r\n\r\n      instance = prepare(isArgsArr ? new target(...args) : new target(args), {\r\n        root,\r\n        // append memoized props with args so it's not forgotten\r\n        memoizedProps: {\r\n          args: isArgsArr && args.length === 0 ? null : args\r\n        }\r\n      });\r\n    } // Auto-attach geometries and materials\r\n\r\n\r\n    if (name.endsWith('Geometry')) {\r\n      props = {\r\n        attach: 'geometry',\r\n        ...props\r\n      };\r\n    } else if (name.endsWith('Material')) {\r\n      props = {\r\n        attach: 'material',\r\n        ...props\r\n      };\r\n    } // It should NOT call onUpdate on object instanciation, because it hasn't been added to the\r\n    // view yet. If the callback relies on references for instance, they won't be ready yet, this is\r\n    // why it passes \"true\" here\r\n\r\n\r\n    applyProps(instance, props, {});\r\n    return instance;\r\n  }\r\n\r\n  function appendChild(parentInstance, child) {\r\n    if (child) {\r\n      if (child.isObject3D) {\r\n        parentInstance.add(child);\r\n      } else {\r\n        parentInstance.__r3f.objects.push(child);\r\n\r\n        child.parent = parentInstance; // The attach attribute implies that the object attaches itself on the parent\r\n\r\n        if (child.attachArray) {\r\n          if (!is.arr(parentInstance[child.attachArray])) parentInstance[child.attachArray] = [];\r\n          parentInstance[child.attachArray].push(child);\r\n        } else if (child.attachObject) {\r\n          if (!is.obj(parentInstance[child.attachObject[0]])) parentInstance[child.attachObject[0]] = {};\r\n          parentInstance[child.attachObject[0]][child.attachObject[1]] = child;\r\n        } else if (child.attach) {\r\n          parentInstance[child.attach] = child;\r\n        }\r\n      }\r\n\r\n      updateInstance(child);\r\n      invalidateInstance(child);\r\n    }\r\n  }\r\n\r\n  function insertBefore(parentInstance, child, beforeChild) {\r\n    if (child) {\r\n      if (child.isObject3D) {\r\n        child.parent = parentInstance;\r\n        child.dispatchEvent({\r\n          type: 'added'\r\n        });\r\n        const restSiblings = parentInstance.children.filter(sibling => sibling !== child); // TODO: the order is out of whack if data objects are present, has to be recalculated\r\n\r\n        const index = restSiblings.indexOf(beforeChild);\r\n        parentInstance.children = [...restSiblings.slice(0, index), child, ...restSiblings.slice(index)];\r\n        updateInstance(child);\r\n      } else {\r\n        appendChild(parentInstance, child);\r\n      } // TODO: order!!!\r\n\r\n\r\n      invalidateInstance(child);\r\n    }\r\n  }\r\n\r\n  function removeRecursive(array, parent, dispose = false) {\r\n    if (array) [...array].forEach(child => removeChild(parent, child, dispose));\r\n  }\r\n\r\n  function removeChild(parentInstance, child, dispose) {\r\n    if (child) {\r\n      var _child$__r3f2;\r\n\r\n      if (child.isObject3D) {\r\n        var _child$__r3f;\r\n\r\n        parentInstance.remove(child); // Remove interactivity\r\n\r\n        if ((_child$__r3f = child.__r3f) != null && _child$__r3f.root) {\r\n          removeInteractivity(child.__r3f.root, child);\r\n        }\r\n      } else {\r\n        child.parent = null;\r\n        if (parentInstance.__r3f.objects) parentInstance.__r3f.objects = parentInstance.__r3f.objects.filter(x => x !== child); // Remove attachment\r\n\r\n        if (child.attachArray) {\r\n          parentInstance[child.attachArray] = parentInstance[child.attachArray].filter(x => x !== child);\r\n        } else if (child.attachObject) {\r\n          delete parentInstance[child.attachObject[0]][child.attachObject[1]];\r\n        } else if (child.attach) {\r\n          parentInstance[child.attach] = null;\r\n        }\r\n      } // Allow objects to bail out of recursive dispose alltogether by passing dispose={null}\r\n      // Never dispose of primitives because their state may be kept outside of React!\r\n      // In order for an object to be able to dispose it has to have\r\n      //   - a dispose method,\r\n      //   - it cannot be an <instance object={...} />\r\n      //   - it cannot be a THREE.Scene, because three has broken it's own api\r\n      //\r\n      // Since disposal is recursive, we can check the optional dispose arg, which will be undefined\r\n      // when the reconciler calls it, but then carry our own check recursively\r\n\r\n\r\n      const isInstance = (_child$__r3f2 = child.__r3f) == null ? void 0 : _child$__r3f2.instance;\r\n      const shouldDispose = dispose === undefined ? child.dispose !== null && !isInstance : dispose; // Remove nested child objects. Primitives should not have objects and children that are\r\n      // attached to them declaratively ...\r\n\r\n      if (!isInstance) {\r\n        var _child$__r3f3;\r\n\r\n        removeRecursive((_child$__r3f3 = child.__r3f) == null ? void 0 : _child$__r3f3.objects, child, shouldDispose);\r\n        removeRecursive(child.children, child, shouldDispose);\r\n      } // Remove references\r\n\r\n\r\n      if (child.__r3f) {\r\n        delete child.__r3f.root;\r\n        delete child.__r3f.objects;\r\n        delete child.__r3f.handlers;\r\n        delete child.__r3f.memoizedProps;\r\n        delete child.__r3f;\r\n      } // Dispose item whenever the reconciler feels like it\r\n\r\n\r\n      if (shouldDispose && child.dispose && child.type !== 'Scene') {\r\n        unstable_runWithPriority(unstable_IdlePriority, () => child.dispose());\r\n      }\r\n\r\n      invalidateInstance(parentInstance);\r\n    }\r\n  }\r\n\r\n  function switchInstance(instance, type, newProps, fiber) {\r\n    const parent = instance.parent;\r\n    if (!parent) return;\r\n    const newInstance = createInstance(type, newProps, instance.__r3f.root);\r\n    removeChild(parent, instance);\r\n    appendChild(parent, newInstance) // This evil hack switches the react-internal fiber node\r\n    // https://github.com/facebook/react/issues/14983\r\n    // https://github.com/facebook/react/pull/15021\r\n    ;\r\n    [fiber, fiber.alternate].forEach(fiber => {\r\n      if (fiber !== null) {\r\n        fiber.stateNode = newInstance;\r\n\r\n        if (fiber.ref) {\r\n          if (typeof fiber.ref === 'function') fiber.ref(newInstance);else fiber.ref.current = newInstance;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  const reconciler = Reconciler({\r\n    now: unstable_now,\r\n    createInstance,\r\n    removeChild,\r\n    appendChild,\r\n    appendInitialChild: appendChild,\r\n    insertBefore,\r\n    warnsIfNotActing: true,\r\n    supportsMutation: true,\r\n    isPrimaryRenderer: false,\r\n    // @ts-ignore\r\n    scheduleTimeout: is.fun(setTimeout) ? setTimeout : undefined,\r\n    // @ts-ignore\r\n    cancelTimeout: is.fun(clearTimeout) ? clearTimeout : undefined,\r\n    // @ts-ignore\r\n    setTimeout: is.fun(setTimeout) ? setTimeout : undefined,\r\n    // @ts-ignore\r\n    clearTimeout: is.fun(clearTimeout) ? clearTimeout : undefined,\r\n    noTimeout: -1,\r\n    appendChildToContainer: (parentInstance, child) => {\r\n      const {\r\n        container,\r\n        root\r\n      } = getContainer(parentInstance, child); // Link current root to the default scene\r\n\r\n      container.__r3f.root = root;\r\n      appendChild(container, child);\r\n    },\r\n    removeChildFromContainer: (parentInstance, child) => {\r\n      const {\r\n        container\r\n      } = getContainer(parentInstance, child);\r\n      removeChild(container, child);\r\n    },\r\n    insertInContainerBefore: (parentInstance, child, beforeChild) => {\r\n      const {\r\n        container\r\n      } = getContainer(parentInstance, child);\r\n      insertBefore(container, child, beforeChild);\r\n    },\r\n\r\n    commitUpdate(instance, updatePayload, type, oldProps, newProps, fiber) {\r\n      if (instance.__r3f.instance && newProps.object && newProps.object !== instance) {\r\n        // <instance object={...} /> where the object reference has changed\r\n        switchInstance(instance, type, newProps, fiber);\r\n      } else {\r\n        // This is a data object, let's extract critical information about it\r\n        const {\r\n          args: argsNew = [],\r\n          ...restNew\r\n        } = newProps;\r\n        const {\r\n          args: argsOld = [],\r\n          ...restOld\r\n        } = oldProps; // If it has new props or arguments, then it needs to be re-instanciated\r\n\r\n        const hasNewArgs = argsNew.some((value, index) => is.obj(value) ? Object.entries(value).some(([key, val]) => val !== argsOld[index][key]) : value !== argsOld[index]);\r\n\r\n        if (hasNewArgs) {\r\n          // Next we create a new instance and append it again\r\n          switchInstance(instance, type, newProps, fiber);\r\n        } else {\r\n          // Otherwise just overwrite props\r\n          applyProps(instance, restNew, restOld, true);\r\n        }\r\n      }\r\n    },\r\n\r\n    hideInstance(instance) {\r\n      if (instance.isObject3D) {\r\n        instance.visible = false;\r\n        invalidateInstance(instance);\r\n      }\r\n    },\r\n\r\n    unhideInstance(instance, props) {\r\n      if (instance.isObject3D && props.visible == null || props.visible) {\r\n        instance.visible = true;\r\n        invalidateInstance(instance);\r\n      }\r\n    },\r\n\r\n    hideTextInstance() {\r\n      throw new Error('Text is not allowed in the R3F tree.');\r\n    },\r\n\r\n    getPublicInstance(instance) {\r\n      // TODO: might fix switchInstance (?)\r\n      return instance;\r\n    },\r\n\r\n    getRootHostContext(rootContainer) {\r\n      return EMPTY;\r\n    },\r\n\r\n    getChildHostContext(parentHostContext) {\r\n      return EMPTY;\r\n    },\r\n\r\n    createTextInstance() {},\r\n\r\n    finalizeInitialChildren(instance) {\r\n      // https://github.com/facebook/react/issues/20271\r\n      // Returning true will trigger commitMount\r\n      return !!instance.__r3f.handlers;\r\n    },\r\n\r\n    commitMount(instance)\r\n    /*, type, props*/\r\n    {\r\n      // https://github.com/facebook/react/issues/20271\r\n      // This will make sure events are only added once to the central container\r\n      if (instance.raycast && instance.__r3f.handlers) instance.__r3f.root.getState().internal.interaction.push(instance);\r\n    },\r\n\r\n    prepareUpdate() {\r\n      return EMPTY;\r\n    },\r\n\r\n    shouldDeprioritizeSubtree() {\r\n      return false;\r\n    },\r\n\r\n    prepareForCommit() {\r\n      return null;\r\n    },\r\n\r\n    preparePortalMount(...args) {// noop\r\n    },\r\n\r\n    resetAfterCommit() {// noop\r\n    },\r\n\r\n    shouldSetTextContent() {\r\n      return false;\r\n    },\r\n\r\n    clearContainer() {\r\n      return false;\r\n    }\r\n\r\n  });\r\n  return {\r\n    reconciler,\r\n    applyProps\r\n  };\r\n}\r\n\r\nconst isRenderer = def => def && !!def.render;\r\nconst isOrthographicCamera = def => def && def.isOrthographicCamera;\r\nconst context = /*#__PURE__*/React.createContext(null);\r\n\r\nconst createStore = (applyProps, invalidate, advance, props) => {\r\n  const {\r\n    gl,\r\n    size,\r\n    shadows = false,\r\n    linear = false,\r\n    flat = false,\r\n    vr = false,\r\n    orthographic = false,\r\n    frameloop = 'always',\r\n    dpr = 1,\r\n    performance,\r\n    clock = new THREE.Clock(),\r\n    raycaster: raycastOptions,\r\n    camera: cameraOptions,\r\n    onPointerMissed\r\n  } = props; // Set shadowmap\r\n\r\n  if (shadows) {\r\n    gl.shadowMap.enabled = true;\r\n    if (typeof shadows === 'object') Object.assign(gl.shadowMap, shadows);else gl.shadowMap.type = THREE.PCFSoftShadowMap;\r\n  } // Set color management\r\n\r\n\r\n  if (!linear) {\r\n    if (!flat) gl.toneMapping = THREE.ACESFilmicToneMapping;\r\n    gl.outputEncoding = THREE.sRGBEncoding;\r\n  }\r\n\r\n  const rootState = create((set, get) => {\r\n    // Create custom raycaster\r\n    const raycaster = new THREE.Raycaster();\r\n    const {\r\n      params,\r\n      ...options\r\n    } = raycastOptions || {};\r\n    applyProps(raycaster, {\r\n      enabled: true,\r\n      ...options,\r\n      params: { ...raycaster.params,\r\n        ...params\r\n      }\r\n    }, {}); // Create default camera\r\n\r\n    const isCamera = cameraOptions instanceof THREE.Camera;\r\n    const camera = isCamera ? cameraOptions : orthographic ? new THREE.OrthographicCamera(0, 0, 0, 0, 0.1, 1000) : new THREE.PerspectiveCamera(75, 0, 0.1, 1000);\r\n\r\n    if (!isCamera) {\r\n      camera.position.z = 5;\r\n      if (cameraOptions) applyProps(camera, cameraOptions, {}); // Always look at center by default\r\n\r\n      camera.lookAt(0, 0, 0);\r\n    }\r\n\r\n    function setDpr(dpr) {\r\n      return Array.isArray(dpr) ? Math.min(Math.max(dpr[0], window.devicePixelRatio), dpr[1]) : dpr;\r\n    }\r\n\r\n    const initialDpr = setDpr(dpr);\r\n    const position = new THREE.Vector3();\r\n    const defaultTarget = new THREE.Vector3();\r\n\r\n    function getCurrentViewport(camera = get().camera, target = defaultTarget, size = get().size) {\r\n      const {\r\n        width,\r\n        height\r\n      } = size;\r\n      const aspect = width / height;\r\n      const distance = camera.getWorldPosition(position).distanceTo(target);\r\n\r\n      if (isOrthographicCamera(camera)) {\r\n        return {\r\n          width: width / camera.zoom,\r\n          height: height / camera.zoom,\r\n          factor: 1,\r\n          distance,\r\n          aspect\r\n        };\r\n      } else {\r\n        const fov = camera.fov * Math.PI / 180; // convert vertical fov to radians\r\n\r\n        const h = 2 * Math.tan(fov / 2) * distance; // visible height\r\n\r\n        const w = h * (width / height);\r\n        return {\r\n          width: w,\r\n          height: h,\r\n          factor: width / w,\r\n          distance,\r\n          aspect\r\n        };\r\n      }\r\n    }\r\n\r\n    let performanceTimeout = undefined;\r\n\r\n    const setPerformanceCurrent = current => set(state => ({\r\n      performance: { ...state.performance,\r\n        current\r\n      }\r\n    }));\r\n\r\n    return {\r\n      gl,\r\n      set,\r\n      get,\r\n      invalidate: () => invalidate(get()),\r\n      advance: (timestamp, runGlobalEffects) => advance(timestamp, runGlobalEffects, get()),\r\n      linear,\r\n      flat,\r\n      scene: prepare(new THREE.Scene()),\r\n      camera,\r\n      raycaster,\r\n      clock,\r\n      mouse: new THREE.Vector2(),\r\n      vr,\r\n      frameloop,\r\n      onPointerMissed,\r\n      performance: {\r\n        current: 1,\r\n        min: 0.5,\r\n        max: 1,\r\n        debounce: 200,\r\n        ...performance,\r\n        regress: () => {\r\n          const state = get(); // Clear timeout\r\n\r\n          if (performanceTimeout) clearTimeout(performanceTimeout); // Set lower bound performance\r\n\r\n          if (state.performance.current !== state.performance.min) setPerformanceCurrent(state.performance.min); // Go back to upper bound performance after a while unless something regresses meanwhile\r\n\r\n          performanceTimeout = setTimeout(() => setPerformanceCurrent(get().performance.max), state.performance.debounce);\r\n        }\r\n      },\r\n      size: {\r\n        width: 0,\r\n        height: 0\r\n      },\r\n      viewport: {\r\n        initialDpr,\r\n        dpr: initialDpr,\r\n        width: 0,\r\n        height: 0,\r\n        aspect: 0,\r\n        distance: 0,\r\n        factor: 0,\r\n        getCurrentViewport\r\n      },\r\n      setSize: (width, height) => {\r\n        const size = {\r\n          width,\r\n          height\r\n        };\r\n        set(state => ({\r\n          size,\r\n          viewport: { ...state.viewport,\r\n            ...getCurrentViewport(camera, defaultTarget, size)\r\n          }\r\n        }));\r\n      },\r\n      setDpr: dpr => set(state => ({\r\n        viewport: { ...state.viewport,\r\n          dpr: setDpr(dpr)\r\n        }\r\n      })),\r\n      events: {\r\n        connected: false\r\n      },\r\n      internal: {\r\n        active: false,\r\n        priority: 0,\r\n        frames: 0,\r\n        lastProps: props,\r\n        interaction: [],\r\n        hovered: new Map(),\r\n        subscribers: [],\r\n        captured: undefined,\r\n        initialClick: [0, 0],\r\n        initialHits: [],\r\n        subscribe: (ref, priority = 0) => {\r\n          set(({\r\n            internal\r\n          }) => ({\r\n            internal: { ...internal,\r\n              // If this subscription was given a priority, it takes rendering into its own hands\r\n              // For that reason we switch off automatic rendering and increase the manual flag\r\n              // As long as this flag is positive (there could be multiple render subscription)\r\n              // ..there can be no internal rendering at all\r\n              priority: internal.priority + (priority ? 1 : 0),\r\n              // Register subscriber and sort layers from lowest to highest, meaning,\r\n              // highest priority renders last (on top of the other frames)\r\n              subscribers: [...internal.subscribers, {\r\n                ref,\r\n                priority\r\n              }].sort((a, b) => a.priority - b.priority)\r\n            }\r\n          }));\r\n          return () => {\r\n            set(({\r\n              internal\r\n            }) => ({\r\n              internal: { ...internal,\r\n                // Decrease manual flag if this subscription had a priority\r\n                priority: internal.priority - (priority ? 1 : 0),\r\n                // Remove subscriber from list\r\n                subscribers: internal.subscribers.filter(s => s.ref !== ref)\r\n              }\r\n            }));\r\n          };\r\n        }\r\n      }\r\n    };\r\n  }); // Resize camera and renderer on changes to size and pixelratio\r\n\r\n  rootState.subscribe(() => {\r\n    const {\r\n      camera,\r\n      size,\r\n      viewport,\r\n      internal\r\n    } = rootState.getState(); // https://github.com/pmndrs/react-three-fiber/issues/92\r\n    // Do not mess with the camera if it belongs to the user\r\n\r\n    if (!(internal.lastProps.camera instanceof THREE.Camera)) {\r\n      if (isOrthographicCamera(camera)) {\r\n        camera.left = size.width / -2;\r\n        camera.right = size.width / 2;\r\n        camera.top = size.height / 2;\r\n        camera.bottom = size.height / -2;\r\n      } else {\r\n        camera.aspect = size.width / size.height;\r\n      }\r\n\r\n      camera.updateProjectionMatrix(); // https://github.com/pmndrs/react-three-fiber/issues/178\r\n      // Update matrix world since the renderer is a frame late\r\n\r\n      camera.updateMatrixWorld();\r\n    } // Update renderer\r\n\r\n\r\n    gl.setPixelRatio(viewport.dpr);\r\n    gl.setSize(size.width, size.height);\r\n  }, state => [state.viewport.dpr, state.size], shallow);\r\n  const state = rootState.getState(); // Update size\r\n\r\n  if (size) state.setSize(size.width, size.height); // Invalidate on any change\r\n\r\n  rootState.subscribe(state => invalidate(state)); // Return root state\r\n\r\n  return rootState;\r\n};\r\n\r\nfunction createSubs(callback, subs) {\r\n  const index = subs.length;\r\n  subs.push(callback);\r\n  return () => void subs.splice(index, 1);\r\n}\r\n\r\nlet i;\r\nlet globalEffects = [];\r\nlet globalAfterEffects = [];\r\nlet globalTailEffects = [];\r\nconst addEffect = callback => createSubs(callback, globalEffects);\r\nconst addAfterEffect = callback => createSubs(callback, globalAfterEffects);\r\nconst addTail = callback => createSubs(callback, globalTailEffects);\r\n\r\nfunction run(effects, timestamp) {\r\n  for (i = 0; i < effects.length; i++) effects[i](timestamp);\r\n}\r\n\r\nfunction render$1(timestamp, state) {\r\n  // Run local effects\r\n  const delta = state.clock.getDelta(); // Call subscribers (useFrame)\r\n\r\n  for (i = 0; i < state.internal.subscribers.length; i++) state.internal.subscribers[i].ref.current(state, delta); // Render content\r\n\r\n\r\n  if (!state.internal.priority && state.gl.render) state.gl.render(state.scene, state.camera); // Decrease frame count\r\n\r\n  state.internal.frames = Math.max(0, state.internal.frames - 1);\r\n  return state.frameloop === 'always' ? 1 : state.internal.frames;\r\n}\r\n\r\nfunction createLoop(roots) {\r\n  let running = false;\r\n  let repeat;\r\n\r\n  function loop(timestamp) {\r\n    running = true;\r\n    repeat = 0; // Run effects\r\n\r\n    run(globalEffects, timestamp); // Render all roots\r\n\r\n    roots.forEach(root => {\r\n      const state = root.store.getState(); // If the frameloop is invalidated, do not run another frame\r\n\r\n      if (state.internal.active && (state.frameloop === 'always' || state.internal.frames > 0)) repeat += render$1(timestamp, state);\r\n    }); // Run after-effects\r\n\r\n    run(globalAfterEffects, timestamp); // Keep on looping if anything invalidates the frameloop\r\n\r\n    if (repeat > 0) return requestAnimationFrame(loop); // Tail call effects, they are called when rendering stops\r\n    else run(globalTailEffects, timestamp); // Flag end of operation\r\n\r\n    running = false;\r\n  }\r\n\r\n  function invalidate(state) {\r\n    if (!state) return roots.forEach(root => invalidate(root.store.getState()));\r\n    if (state.vr || !state.internal.active || state.frameloop === 'never') return; // Increase frames, do not go higher than 60\r\n\r\n    state.internal.frames = Math.min(60, state.internal.frames + 1); // If the render-loop isn't active, start it\r\n\r\n    if (!running) {\r\n      running = true;\r\n      requestAnimationFrame(loop);\r\n    }\r\n  }\r\n\r\n  function advance(timestamp, runGlobalEffects = true, state) {\r\n    if (runGlobalEffects) run(globalEffects, timestamp);\r\n    if (!state) roots.forEach(root => render$1(timestamp, root.store.getState()));else render$1(timestamp, state);\r\n    if (runGlobalEffects) run(globalAfterEffects, timestamp);\r\n  }\r\n\r\n  return {\r\n    loop,\r\n    invalidate,\r\n    advance\r\n  };\r\n}\r\n\r\nfunction createPointerEvents(store) {\r\n  const {\r\n    handlePointer\r\n  } = createEvents(store);\r\n  const names = {\r\n    onClick: 'click',\r\n    onContextMenu: 'contextmenu',\r\n    onDoubleClick: 'dblclick',\r\n    onWheel: 'wheel',\r\n    onPointerDown: 'pointerdown',\r\n    onPointerUp: 'pointerup',\r\n    onPointerLeave: 'pointerleave',\r\n    onPointerMove: 'pointermove',\r\n    onPointerCancel: 'pointercancel',\r\n    onLostPointerCapture: 'lostpointercapture'\r\n  };\r\n  return {\r\n    connected: false,\r\n    handlers: Object.keys(names).reduce((acc, key) => ({ ...acc,\r\n      [key]: handlePointer(key)\r\n    }), {}),\r\n    connect: target => {\r\n      var _events$handlers;\r\n\r\n      const {\r\n        set,\r\n        events\r\n      } = store.getState();\r\n      events.disconnect == null ? void 0 : events.disconnect();\r\n      set(state => ({\r\n        events: { ...state.events,\r\n          connected: target\r\n        }\r\n      }));\r\n      Object.entries((_events$handlers = events == null ? void 0 : events.handlers) != null ? _events$handlers : []).forEach(([name, event]) => target.addEventListener(names[name], event, {\r\n        passive: true\r\n      }));\r\n    },\r\n    disconnect: () => {\r\n      const {\r\n        set,\r\n        events\r\n      } = store.getState();\r\n\r\n      if (events.connected) {\r\n        var _events$handlers2;\r\n\r\n        Object.entries((_events$handlers2 = events.handlers) != null ? _events$handlers2 : []).forEach(([name, event]) => {\r\n          if (events && events.connected instanceof HTMLElement) {\r\n            events.connected.removeEventListener(names[name], event);\r\n          }\r\n        });\r\n        set(state => ({\r\n          events: { ...state.events,\r\n            connected: false\r\n          }\r\n        }));\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\n// React currently throws a warning when using useLayoutEffect on the server.\r\n// To get around it, we can conditionally useEffect on the server (no-op) and\r\n// useLayoutEffect in the browser.\r\nconst useIsomorphicLayoutEffect = typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect;\r\nfunction Canvas({\r\n  children,\r\n  tabIndex,\r\n  resize,\r\n  id,\r\n  style,\r\n  className,\r\n  events,\r\n  ...props\r\n}) {\r\n  const [ref, size] = useMeasure({\r\n    scroll: true,\r\n    debounce: {\r\n      scroll: 50,\r\n      resize: 0\r\n    },\r\n    ...resize\r\n  });\r\n  const canvas = React.useRef(null);\r\n  useIsomorphicLayoutEffect(() => {\r\n    if (size.width > 0 && size.height > 0) {\r\n      render(children, canvas.current, { ...props,\r\n        size,\r\n        events: events || createPointerEvents\r\n      });\r\n    }\r\n  }, [size, children]);\r\n  React.useEffect(() => {\r\n    const container = canvas.current;\r\n    return () => unmountComponentAtNode(container);\r\n  }, []);\r\n  return /*#__PURE__*/React.createElement(\"div\", {\r\n    ref: ref,\r\n    id: id,\r\n    className: className,\r\n    tabIndex: tabIndex,\r\n    style: {\r\n      position: 'relative',\r\n      width: '100%',\r\n      height: '100%',\r\n      overflow: 'hidden',\r\n      ...style\r\n    }\r\n  }, /*#__PURE__*/React.createElement(\"canvas\", {\r\n    ref: canvas,\r\n    style: {\r\n      display: 'block'\r\n    }\r\n  }));\r\n}\r\n\r\nfunction useThree(selector = state => state, equalityFn) {\r\n  const useStore = React.useContext(context);\r\n  if (!useStore) throw `R3F hooks can only be used within the Canvas component!`;\r\n  return useStore(selector, equalityFn);\r\n}\r\nfunction useFrame(callback, renderPriority = 0) {\r\n  const {\r\n    subscribe\r\n  } = React.useContext(context).getState().internal; // Update ref\r\n\r\n  const ref = React.useRef(callback);\r\n  React.useLayoutEffect(() => void (ref.current = callback), [callback]); // Subscribe/unsub\r\n\r\n  React.useEffect(() => {\r\n    const unsubscribe = subscribe(ref, renderPriority);\r\n    return () => unsubscribe();\r\n  }, [renderPriority, subscribe]);\r\n  return null;\r\n}\r\n\r\nfunction buildGraph(object) {\r\n  const data = {\r\n    nodes: {},\r\n    materials: {}\r\n  };\r\n\r\n  if (object) {\r\n    object.traverse(obj => {\r\n      if (obj.name) {\r\n        data.nodes[obj.name] = obj;\r\n      }\r\n\r\n      if (obj.material && !data.materials[obj.material.name]) {\r\n        data.materials[obj.material.name] = obj.material;\r\n      }\r\n    });\r\n  }\r\n\r\n  return data;\r\n}\r\n\r\nfunction useGraph(object) {\r\n  return React.useMemo(() => buildGraph(object), [object]);\r\n}\r\n\r\nfunction loadingFn(extensions, onProgress) {\r\n  return function (Proto, ...input) {\r\n    // Construct new loader and run extensions\r\n    const loader = new Proto();\r\n    if (extensions) extensions(loader); // Go through the urls and load them\r\n\r\n    return Promise.all(input.map(input => new Promise((res, reject) => loader.load(input, data => {\r\n      if (data.scene) Object.assign(data, buildGraph(data.scene));\r\n      res(data);\r\n    }, onProgress, error => {\r\n      var _error$message;\r\n\r\n      return reject((_error$message = error.message) != null ? _error$message : `failure loading ${input}`);\r\n    }))));\r\n  };\r\n}\r\n\r\nfunction useLoader(Proto, input, extensions, onProgress) {\r\n  // Use suspense to load async assets\r\n  const keys = Array.isArray(input) ? input : [input];\r\n  const results = useAsset(loadingFn(extensions, onProgress), Proto, ...keys); // Return the object/s\r\n\r\n  return Array.isArray(input) ? results : results[0];\r\n}\r\n\r\nuseLoader.preload = function (Proto, input, extensions) {\r\n  const keys = Array.isArray(input) ? input : [input];\r\n  return useAsset.preload(loadingFn(extensions), Proto, ...keys);\r\n};\r\n\r\nconst roots = new Map();\r\nconst modes = ['legacy', 'blocking', 'concurrent'];\r\nconst {\r\n  invalidate,\r\n  advance\r\n} = createLoop(roots);\r\nconst {\r\n  reconciler,\r\n  applyProps\r\n} = createRenderer();\r\n\r\nconst createRendererInstance = (gl, canvas) => isRenderer(gl) ? gl : new THREE.WebGLRenderer({\r\n  powerPreference: 'high-performance',\r\n  canvas: canvas,\r\n  antialias: true,\r\n  alpha: true,\r\n  ...gl\r\n});\r\n\r\nfunction render(element, canvas, {\r\n  gl,\r\n  size,\r\n  mode = modes[1],\r\n  events,\r\n  onCreated,\r\n  ...props\r\n} = {}) {\r\n  var _store;\r\n\r\n  // Allow size to take on container bounds initially\r\n  if (!size) {\r\n    var _canvas$parentElement, _canvas$parentElement2, _canvas$parentElement3, _canvas$parentElement4;\r\n\r\n    size = {\r\n      width: (_canvas$parentElement = (_canvas$parentElement2 = canvas.parentElement) == null ? void 0 : _canvas$parentElement2.clientWidth) != null ? _canvas$parentElement : 0,\r\n      height: (_canvas$parentElement3 = (_canvas$parentElement4 = canvas.parentElement) == null ? void 0 : _canvas$parentElement4.clientHeight) != null ? _canvas$parentElement3 : 0\r\n    };\r\n  }\r\n\r\n  let root = roots.get(canvas);\r\n  let fiber = root == null ? void 0 : root.fiber;\r\n  let store = root == null ? void 0 : root.store;\r\n  let state = (_store = store) == null ? void 0 : _store.getState();\r\n\r\n  if (fiber && state) {\r\n    const lastProps = state.internal.lastProps; // When a root was found, see if any fundamental props must be changed or exchanged\r\n    // Check pixelratio\r\n\r\n    if (props.dpr !== undefined && !is.equ(lastProps.dpr, props.dpr)) state.setDpr(props.dpr); // Check size\r\n\r\n    if (size !== undefined && !is.equ(lastProps.size, size)) state.setSize(size.width, size.height); // For some props we want to reset the entire root\r\n    // Changes to the color-space\r\n\r\n    const linearChanged = props.linear !== lastProps.linear;\r\n\r\n    if (linearChanged) {\r\n      unmountComponentAtNode(canvas);\r\n      fiber = undefined;\r\n    }\r\n  }\r\n\r\n  if (!fiber) {\r\n    // If no root has been found, make one\r\n    // Create gl\r\n    const glRenderer = createRendererInstance(gl, canvas); // Enable VR if requested\r\n\r\n    if (props.vr) {\r\n      glRenderer.xr.enabled = true;\r\n      glRenderer.setAnimationLoop(timestamp => advance(timestamp, true));\r\n    } // Create store\r\n\r\n\r\n    store = createStore(applyProps, invalidate, advance, {\r\n      gl: glRenderer,\r\n      size,\r\n      ...props\r\n    });\r\n    const state = store.getState();\r\n    state.get; // Create renderer\r\n\r\n    fiber = reconciler.createContainer(store, modes.indexOf(mode), false, null); // Map it\r\n\r\n    roots.set(canvas, {\r\n      fiber,\r\n      store\r\n    }); // Store events internally\r\n\r\n    if (events) state.set({\r\n      events: events(store)\r\n    });\r\n  }\r\n\r\n  if (store && fiber) {\r\n    reconciler.updateContainer( /*#__PURE__*/React.createElement(Provider, {\r\n      store: store,\r\n      element: element,\r\n      onCreated: onCreated,\r\n      target: canvas\r\n    }), fiber, null, () => undefined);\r\n    return store;\r\n  } else {\r\n    throw 'Error creating root!';\r\n  }\r\n}\r\n\r\nfunction Provider({\r\n  store,\r\n  element,\r\n  onCreated,\r\n  target\r\n}) {\r\n  React.useEffect(() => {\r\n    const state = store.getState(); // Flag the canvas active, rendering will now begin\r\n\r\n    state.set(state => ({\r\n      internal: { ...state.internal,\r\n        active: true\r\n      }\r\n    })); // Connect events\r\n\r\n    state.events.connect == null ? void 0 : state.events.connect(target); // Notifiy that init is completed, the scene graph exists, but nothing has yet rendered\r\n\r\n    if (onCreated) onCreated(state);\r\n  }, []);\r\n  return /*#__PURE__*/React.createElement(context.Provider, {\r\n    value: store\r\n  }, element);\r\n}\r\n\r\nfunction unmountComponentAtNode(canvas, callback) {\r\n  const root = roots.get(canvas);\r\n  const fiber = root == null ? void 0 : root.fiber;\r\n\r\n  if (fiber) {\r\n    const state = root == null ? void 0 : root.store.getState();\r\n    if (state) state.internal.active = false;\r\n    reconciler.updateContainer(null, fiber, null, () => {\r\n      if (state) {\r\n        setTimeout(() => {\r\n          var _state$gl, _state$gl$renderLists, _state$gl2;\r\n\r\n          state.events.disconnect == null ? void 0 : state.events.disconnect();\r\n          (_state$gl = state.gl) == null ? void 0 : (_state$gl$renderLists = _state$gl.renderLists) == null ? void 0 : _state$gl$renderLists.dispose == null ? void 0 : _state$gl$renderLists.dispose();\r\n          (_state$gl2 = state.gl) == null ? void 0 : _state$gl2.forceContextLoss == null ? void 0 : _state$gl2.forceContextLoss();\r\n          dispose(state);\r\n          roots.delete(canvas);\r\n          if (callback) callback(canvas);\r\n        }, 500);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction dispose(obj) {\r\n  if (obj.dispose && obj.type !== 'Scene') obj.dispose();\r\n\r\n  for (const p in obj) {\r\n    var _dispose, _ref;\r\n    (_dispose = (_ref = p).dispose) == null ? void 0 : _dispose.call(_ref);\r\n    delete obj[p];\r\n  }\r\n}\r\n\r\nconst act = reconciler.act;\r\nconst hasSymbol = is.fun(Symbol) && Symbol.for;\r\nconst REACT_PORTAL_TYPE = hasSymbol ? Symbol.for('react.portal') : 0xeaca;\r\n\r\nfunction createPortal(children, container, implementation, key = null) {\r\n  return {\r\n    $$typeof: REACT_PORTAL_TYPE,\r\n    key: key == null ? null : '' + key,\r\n    children,\r\n    containerInfo: prepare(container),\r\n    implementation\r\n  };\r\n}\r\n\r\nreconciler.injectIntoDevTools({\r\n  bundleType: process.env.NODE_ENV === 'production' ? 0 : 1,\r\n  rendererPackageName: '@react-three/fiber',\r\n  version: '17.0.2'\r\n});\r\n\r\nexport { Canvas, threeTypes as ReactThreeFiber, roots as _roots, act, addAfterEffect, addEffect, addTail, advance, applyProps, context, createPortal, dispose, createPointerEvents as events, extend, invalidate, reconciler, render, unmountComponentAtNode, useFrame, useGraph, useLoader, useThree };\r\n"]},"metadata":{},"sourceType":"module"}